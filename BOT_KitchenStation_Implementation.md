# BOT (Bar Order Ticket) Separation from KOT Implementation

## Overview
This implementation ensures that Bar orders generate **BOT (Bar Order Tickets)** with separate numbering from Food orders that use **KOT (Kitchen Order Tickets)**. BOT tickets are filtered by "BAR" kitchen station and appear only in the Bar Dashboard.

## Changes Made

### 1. Database Schema Changes

#### A. Added KitchenStation Column to BOT_Header
- **File**: `SQL/Add_KitchenStation_To_BOT.sql`
- **Purpose**: Allows filtering BOT tickets by kitchen station
- **Default Value**: 'BAR'
- **Indexed**: Yes (IX_BOT_Header_KitchenStation)

#### B. Updated Stored Procedures

**GetBOTsByStatus** (`SQL/Update_GetBOTsByStatus_Procedure.sql`)
- Added `@KitchenStation` parameter (default: 'BAR')
- Filters BOT tickets by kitchen station
- Backward compatible if KitchenStation column doesn't exist

**GetBOTDashboardStats** (`SQL/Update_GetBOTDashboardStats_Procedure.sql`)
- Added `@KitchenStation` parameter (default: 'BAR')
- Dashboard statistics now filtered by kitchen station
- Ensures Bar Dashboard shows only BAR ticket stats

### 2. Code Changes

#### A. OrderController.cs - CreateBOT Method
**Location**: Line ~3088
**Changes**:
- Checks if KitchenStation column exists in BOT_Header
- Sets KitchenStation = 'BAR' when creating new BOT tickets
- Backward compatible - works without the column for existing deployments

**Code Flow**:
1. Checks for KitchenStation column existence
2. If exists: INSERT with KitchenStation = 'BAR'
3. If not exists: INSERT without KitchenStation (fallback)

#### B. BOTController.cs - GetBOTsByStatus Method
**Location**: Line ~329
**Changes**:
- Added `@KitchenStation` parameter set to 'BAR'
- Filters all BOT dashboard queries by BAR station

#### C. BOTController.cs - GetDashboardStats Method
**Location**: Line ~276
**Changes**:
- Added `@KitchenStation` parameter set to 'BAR'
- Dashboard statistics filtered to show only BAR tickets

### 3. Ticket Numbering

**BOT (Bar Order Tickets)**:
- Format: `BOT-YYYYMMDD-####`
- Example: `BOT-20251101-0001`
- Generated by: `GetNextBOTNumber` stored procedure
- Sequence: Separate from KOT

**KOT (Kitchen Order Tickets)**:
- Format: `KOT-YYYYMMDD-####`
- Example: `KOT-20251101-0001`
- Generated by: FireItemsToKitchen logic in OrderController
- Sequence: Separate from BOT

### 4. Order Processing Flow

#### Bar Orders (fromBar=True)
1. User clicks "Fire to Bar" on Order Details page
2. System classifies items:
   - Bar items (menuitemgroupID = 'Bar') → BOT
   - Food items (other groups) → KOT
3. Creates BOT for bar items:
   - BOT_No: BOT-YYYYMMDD-####
   - KitchenStation: 'BAR'
   - Status: 0 (New)
4. Creates KOT for food items (if any)
5. Updates OrderItems status to 1 (InProgress)

#### Food Orders (fromBar=False or default)
1. User clicks "Fire to Kitchen" on Order Details page
2. System processes all food items
3. Creates KOT:
   - TicketNumber: KOT-YYYYMMDD-####
   - Sent to kitchen stations
4. No BOT created for pure food orders

### 5. Dashboard Filtering

#### Bar Dashboard (`/BOT/Dashboard`)
- Shows only tickets where `KitchenStation = 'BAR'`
- Statistics filtered by BAR station
- Displays BOT-#### numbered tickets only

#### Order Dashboard (`/Order/Dashboard`)
- Shows all orders regardless of ticket type
- No filtering by KitchenStation
- Displays both KOT and BOT associated orders

## Deployment Steps

### Step 1: Run Database Scripts (IN ORDER)
```sql
-- 1. Add KitchenStation column
-- Run: SQL/Add_KitchenStation_To_BOT.sql

-- 2. Update GetBOTsByStatus procedure
-- Run: SQL/Update_GetBOTsByStatus_Procedure.sql

-- 3. Update GetBOTDashboardStats procedure
-- Run: SQL/Update_GetBOTDashboardStats_Procedure.sql
```

### Step 2: Deploy Code
```bash
# Build and deploy the application
dotnet build RestaurantManagementSystem/RestaurantManagementSystem/RestaurantManagementSystem.csproj
dotnet publish -c Release
```

### Step 3: Restart Application
```bash
# Kill existing process
lsof -ti:5290 | xargs kill -9 2>/dev/null || true

# Start application
dotnet run --project RestaurantManagementSystem/RestaurantManagementSystem/RestaurantManagementSystem.csproj
```

## Testing Checklist

### Test 1: Bar Order with Bar Items Only
- [ ] Create order via Bar → Bar Order Create
- [ ] Add bar items (from "Bar" menu group)
- [ ] Click "Fire to Bar"
- [ ] Verify BOT ticket created (BOT-YYYYMMDD-####)
- [ ] Check Bar Dashboard - BOT should appear
- [ ] Verify KitchenStation = 'BAR' in database

### Test 2: Bar Order with Mixed Items (Bar + Food)
- [ ] Create order via Bar → Bar Order Create
- [ ] Add bar items + food items
- [ ] Click "Fire to Bar"
- [ ] Verify BOT created for bar items
- [ ] Verify KOT created for food items
- [ ] Check Bar Dashboard - only BOT appears
- [ ] Check Kitchen Dashboard - only KOT appears

### Test 3: Food Order (Regular Order)
- [ ] Create order via Orders → Order Dashboard → New Order
- [ ] Add food items only
- [ ] Click "Fire to Kitchen"
- [ ] Verify KOT ticket created (KOT-YYYYMMDD-####)
- [ ] Verify NO BOT created
- [ ] Check Bar Dashboard - order does NOT appear

### Test 4: Dashboard Filtering
- [ ] Access `/BOT/Dashboard`
- [ ] Verify only BOT tickets displayed
- [ ] Check statistics match BOT tickets only
- [ ] Filter by status - should still show only BAR station tickets

### Test 5: Backward Compatibility
- [ ] If KitchenStation column doesn't exist:
  - [ ] BOT creation should still work
  - [ ] Dashboard queries should fallback gracefully
  - [ ] No errors in logs

## Database Verification Queries

```sql
-- Check KitchenStation column exists
SELECT * FROM sys.columns 
WHERE object_id = OBJECT_ID('dbo.BOT_Header') 
AND name = 'KitchenStation';

-- View all BOT tickets with KitchenStation
SELECT BOT_ID, BOT_No, KitchenStation, OrderId, Status, CreatedAt
FROM BOT_Header
ORDER BY CreatedAt DESC;

-- Count BOT tickets by KitchenStation
SELECT KitchenStation, COUNT(*) as Count, 
       SUM(TotalAmount) as TotalSales
FROM BOT_Header
WHERE CAST(CreatedAt AS DATE) = CAST(GETDATE() AS DATE)
GROUP BY KitchenStation;

-- Verify BOT numbering is separate from KOT
SELECT 'BOT' as TicketType, BOT_No as TicketNumber, CreatedAt
FROM BOT_Header
WHERE CAST(CreatedAt AS DATE) = CAST(GETDATE() AS DATE)
UNION ALL
SELECT 'KOT' as TicketType, TicketNumber, CreatedAt
FROM KitchenTickets
WHERE CAST(CreatedAt AS DATE) = CAST(GETDATE() AS DATE)
ORDER BY CreatedAt DESC;
```

## Rollback Plan

If issues occur, rollback in reverse order:

### Step 1: Revert Code Changes
```bash
git checkout HEAD~1 -- Controllers/OrderController.cs
git checkout HEAD~1 -- Controllers/BOTController.cs
dotnet build
```

### Step 2: Remove KitchenStation Column (if needed)
```sql
-- Only if you need to completely rollback database changes
ALTER TABLE BOT_Header DROP COLUMN KitchenStation;

-- Restore original stored procedures
-- Re-run original BOT_Setup.sql procedures section
```

## Benefits

1. **Separate Ticket Numbering**: BOT and KOT have independent sequences
2. **Clear Separation**: Bar staff see only bar orders in their dashboard
3. **Kitchen Isolation**: Kitchen staff don't see bar orders in their flow
4. **Accurate Metrics**: Dashboard stats reflect only relevant station activity
5. **Backward Compatible**: Works with or without KitchenStation column
6. **Audit Trail**: KitchenStation field provides clear tracking

## Technical Notes

- **Thread Safety**: BOT numbering uses database-level sequence generation
- **Performance**: KitchenStation index ensures fast dashboard queries
- **Scalability**: Can add more kitchen stations (e.g., 'GRILL', 'PASTRY') using same pattern
- **Error Handling**: All database checks include existence verification before operations

## Support

For issues or questions:
1. Check application logs: Look for errors from BOTController or OrderController
2. Verify database scripts executed successfully
3. Confirm KitchenStation column exists and is indexed
4. Test stored procedures manually with SQL Management Studio

---
**Version**: 1.0  
**Date**: 2025-11-01  
**Author**: Restaurant Management System Team
