@model RestaurantManagementSystem.Models.InventoryDashboardViewModel
@{
    ViewData["Title"] = "Inventory Dashboard";
}

<style>
    .inventory-dashboard-shell {
        background: #f4f6f9;
        min-height: 100vh;
        padding: 0.25rem;
    }

    .inventory-page-title {
        color: #1f2937;
        font-weight: 700;
        margin-bottom: 0.25rem;
    }

    .inventory-page-subtitle {
        color: #6b7280;
        font-weight: 600;
        margin-bottom: 1rem;
    }

    .inventory-kpi-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    }

    .inventory-kpi-card .kpi-label {
        font-size: 0.78rem;
        font-weight: 600;
        text-transform: uppercase;
        letter-spacing: 0.3px;
    }

    .inventory-panel,
    .inventory-qa-card {
        border: 1px solid #e5e7eb;
        border-radius: 10px;
        box-shadow: 0 2px 8px rgba(15, 23, 42, 0.06);
    }

    .inventory-section-title {
        color: #1f2937;
        font-weight: 700;
        margin-bottom: 0.75rem;
    }
</style>

<div class="container-fluid inventory-dashboard-shell">

<h2 class="inventory-page-title">Inventory Dashboard</h2>

@if (TempData["ResultMessage"] != null)
{
    <div class="alert alert-info">@TempData["ResultMessage"]</div>
}

<h5 class="inventory-page-subtitle">Inventory Insights</h5>

<div class="row g-3 mb-4">
    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-primary-subtle text-primary-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Tracked Items</div>
                <div class="fs-4 fw-bold">@Model.TotalTrackedItems</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-success-subtle text-success-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Qty On Hand</div>
                <div class="fs-4 fw-bold">@Model.TotalQuantityOnHand.ToString("0.###")</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-danger-subtle text-danger-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Low Stock</div>
                <div class="fs-4 fw-bold">@Model.LowStockItemsCount</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-info-subtle text-info-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Today In</div>
                <div class="fs-4 fw-bold">@Model.TodayStockInQuantity.ToString("0.###")</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-warning-subtle text-warning-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Today Out</div>
                <div class="fs-4 fw-bold">@Model.TodayStockOutQuantity.ToString("0.###")</div>
            </div>
        </div>
    </div>

    <div class="col-md-4 col-xl-2">
        <div class="card inventory-kpi-card bg-secondary-subtle text-secondary-emphasis h-100">
            <div class="card-body">
                <div class="kpi-label">Active Masters</div>
                <div class="fw-semibold">Godowns: @Model.ActiveGodownsCount</div>
                <div class="fw-semibold">Parties: @Model.ActivePartiesCount</div>
            </div>
        </div>
    </div>
</div>

<div class="row g-3 mb-4">
    <div class="col-lg-6">
        <div class="card inventory-panel h-100">
            <div class="card-header bg-white fw-semibold">Low Stock Items</div>
            <div class="card-body p-0">
                <div class="table-responsive">
                    <table class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th>Godown</th>
                                <th class="text-end">On Hand</th>
                                <th class="text-end">Low Level</th>
                            </tr>
                        </thead>
                        <tbody>
                            @if (Model.LowStockItems.Any())
                            {
                                foreach (var item in Model.LowStockItems)
                                {
                                    <tr>
                                        <td>@item.MenuItemName</td>
                                        <td>@item.GodownName</td>
                                        <td class="text-end">@item.QuantityOnHand.ToString("0.###")</td>
                                        <td class="text-end">@item.LowLevelQty?.ToString("0.###")</td>
                                    </tr>
                                }
                            }
                            else
                            {
                                <tr>
                                    <td colspan="4" class="text-center text-muted py-3">No low stock items.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>

    <div class="col-lg-6">
        <div class="card inventory-panel h-100">
            <div class="card-header bg-white fw-semibold">Item-wise Stock Information</div>
            <div class="card-body p-0">
                <div class="p-2 border-bottom bg-white">
                    <div class="row g-2">
                        <div class="col-md-7">
                            <input id="itemWiseStockSearch" type="text" class="form-control form-control-sm" placeholder="Search by item name..." />
                        </div>
                        <div class="col-md-5">
                            <select id="itemWiseStockSort" class="form-select form-select-sm">
                                <option value="name-asc">Sort: Name A-Z</option>
                                <option value="name-desc">Sort: Name Z-A</option>
                                <option value="qty-desc">Sort: Qty High-Low</option>
                                <option value="qty-asc">Sort: Qty Low-High</option>
                            </select>
                        </div>
                    </div>
                </div>
                <div class="table-responsive">
                    <table id="itemWiseStockTable" class="table table-sm table-striped mb-0">
                        <thead>
                            <tr>
                                <th>Item</th>
                                <th class="text-end">Total On hand</th>
                                <th>Godown</th>
                                <th class="text-end">Low Stock</th>
                                <th>Last Updated</th>
                            </tr>
                        </thead>
                        <tbody id="itemWiseStockBody">
                            @if (Model.ItemWiseStocks.Any())
                            {
                                foreach (var item in Model.ItemWiseStocks)
                                {
                                    <tr class="item-wise-stock-row" data-item-name="@item.MenuItemName.ToLowerInvariant()" data-total-qty="@item.TotalQuantityOnHand">
                                        <td>@item.MenuItemName</td>
                                        <td class="text-end">@item.TotalQuantityOnHand.ToString("0.###")</td>
                                        <td>@item.GodownNames</td>
                                        <td class="text-end">
                                            @if (item.LowStockGodownCount > 0)
                                            {
                                                <span class="badge bg-danger">@item.LowStockGodownCount</span>
                                            }
                                            else
                                            {
                                                <span class="badge bg-success">0</span>
                                            }
                                        </td>
                                        <td>@(item.LastUpdatedAt.HasValue ? item.LastUpdatedAt.Value.ToLocalTime().ToString("dd-MMM HH:mm") : "-")</td>
                                    </tr>
                                }
                                <tr id="itemWiseStockNoMatchRow" style="display:none;">
                                    <td colspan="5" class="text-center text-muted py-3">No matching item found.</td>
                                </tr>
                            }
                            else
                            {
                                <tr>
                                    <td colspan="5" class="text-center text-muted py-3">No item-wise stock data available.</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script>
        (function () {
            const sortStorageKey = 'InventoryDashboard.ItemWiseStock.Sort';
            const searchInput = document.getElementById('itemWiseStockSearch');
            const sortSelect = document.getElementById('itemWiseStockSort');
            const tbody = document.getElementById('itemWiseStockBody');
            const rows = Array.from(document.querySelectorAll('.item-wise-stock-row'));
            const noMatchRow = document.getElementById('itemWiseStockNoMatchRow');

            if (!searchInput || !sortSelect || !tbody || rows.length === 0) {
                return;
            }

            function applyFilterAndSort() {
                const term = (searchInput.value || '').toLowerCase().trim();
                const sortBy = sortSelect.value;

                rows.sort(function (a, b) {
                    const aName = (a.dataset.itemName || '').toLowerCase();
                    const bName = (b.dataset.itemName || '').toLowerCase();
                    const aQty = parseFloat(a.dataset.totalQty || '0');
                    const bQty = parseFloat(b.dataset.totalQty || '0');

                    if (sortBy === 'name-desc') {
                        return bName.localeCompare(aName);
                    }
                    if (sortBy === 'qty-desc') {
                        return bQty - aQty;
                    }
                    if (sortBy === 'qty-asc') {
                        return aQty - bQty;
                    }
                    return aName.localeCompare(bName);
                });

                rows.forEach(function (row) {
                    tbody.appendChild(row);
                });

                let visibleCount = 0;

                rows.forEach(function (row) {
                    const itemName = (row.dataset.itemName || '').toLowerCase();
                    const isMatch = term.length === 0 || itemName.indexOf(term) !== -1;
                    row.style.display = isMatch ? '' : 'none';
                    if (isMatch) {
                        visibleCount++;
                    }
                });

                if (noMatchRow) {
                    noMatchRow.style.display = visibleCount === 0 ? '' : 'none';
                }
            }

            try {
                const savedSort = localStorage.getItem(sortStorageKey);
                if (savedSort && Array.from(sortSelect.options).some(function (option) { return option.value === savedSort; })) {
                    sortSelect.value = savedSort;
                }
            } catch (e) {
            }

            searchInput.addEventListener('input', applyFilterAndSort);
            sortSelect.addEventListener('change', function () {
                try {
                    localStorage.setItem(sortStorageKey, sortSelect.value);
                } catch (e) {
                }
                applyFilterAndSort();
            });
            applyFilterAndSort();
        })();
    </script>
}

<h5 class="inventory-section-title">Quick Actions</h5>

<div class="row g-3">
    <div class="col-md-4">
        <div class="card inventory-qa-card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">Godown Master</h5>
                <p class="card-text text-muted">Manage godown list with create and edit options.</p>
                <a class="btn btn-primary mt-auto" asp-controller="Inventory" asp-action="GodownMaster">Open Godown Master</a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card inventory-qa-card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">Party Master</h5>
                <p class="card-text text-muted">Manage vendor, suppliers and traders master records.</p>
                <a class="btn btn-primary mt-auto" asp-controller="Inventory" asp-action="PartyMaster">Open Party Master</a>
            </div>
        </div>
    </div>

    <div class="col-md-4">
        <div class="card inventory-qa-card h-100">
            <div class="card-body d-flex flex-column">
                <h5 class="card-title">Stock In</h5>
                <p class="card-text text-muted">Add and track inward stock transactions by godown.</p>
                <a class="btn btn-primary mt-auto" asp-controller="Inventory" asp-action="StockIn">Open Stock In</a>
            </div>
        </div>
    </div>
</div>

</div>
