@model CreateOrderViewModel
@using RestaurantManagementSystem.Helpers
@{
    ViewData["Title"] = "Create New Order";
}


<div class="container py-5" style="background: linear-gradient(135deg, #1e293b 0%, #334155 50%, #0f172a 100%); min-height: 100vh;">
    <div class="row justify-content-center">
        <div class="col-lg-7 col-md-10">
            <div class="card shadow-lg border-0 rounded-4" style="box-shadow: 0 20px 60px rgba(0,0,0,.4) !important;">
                <div class="card-header text-white d-flex align-items-center" style="background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); border-top-left-radius: 1rem; border-top-right-radius: 1rem; border: none;">
                    <span class="me-2"><i class="fas fa-receipt" style="font-size:2rem;"></i></span>
                    <h4 class="mb-0 flex-grow-1">@ViewData["Title"]</h4>
                    <a asp-action="Dashboard" class="btn ms-auto" style="background: rgba(255,255,255,.2); backdrop-filter: blur(10px); color: white; border: 1px solid rgba(255,255,255,.3);"><i class="fas fa-arrow-left"></i></a>
                </div>
                <div class="card-body px-4 py-4" style="background: rgba(255,255,255,0.98); border-bottom-left-radius: 1rem; border-bottom-right-radius: 1rem;">
                    @if (TempData["SuccessMessage"] != null)
                    {
                        <div class="alert alert-success">@TempData["SuccessMessage"]</div>
                    }
                    @if (!ViewData.ModelState.IsValid)
                    {
                        <div class="alert alert-danger">
                            <strong>Please correct the errors below.</strong>
                            <ul class="mb-0">
                            @foreach (var entry in ViewData.ModelState)
                            {
                                foreach (var error in entry.Value.Errors)
                                {
                                    <li><b>@entry.Key</b>: @error.ErrorMessage</li>
                                }
                            }
                            </ul>
                        </div>
                    }
                    <form asp-action="Create" method="post" autocomplete="off" id="createOrderForm">
                        <div asp-validation-summary="ModelOnly" class="text-danger mb-3"></div>
                        <div class="row g-4">
                            <div class="col-md-6">
                                <div class="mb-2 text-secondary fw-bold" style="font-size:1.1rem;">Order Info</div>
                                <label asp-for="OrderType" class="form-label">Order Type</label>
                                <select asp-for="OrderType" class="form-select" id="orderType">
                                    @{
                                        var allowed = ViewBag.AllowedOrderTypeIds as List<int>;
                                        if (allowed == null || allowed.Count == 0)
                                        {
                                            allowed = OrderTypeHelper.GetOrderTypes().Select(x => x.Id).ToList();
                                        }

                                        foreach (var ot in OrderTypeHelper.GetOrderTypes().Where(x => allowed.Contains(x.Id)))
                                        {
                                            <option value="@ot.Id">@ot.Name</option>
                                        }
                                    }
                                </select>
                                <span asp-validation-for="OrderType" class="text-danger"></span>
                                <div id="tableSection" class="mt-3">
                                    <label asp-for="TableTurnoverId" class="form-label">Table (Primary)</label>
                                    <div class="form-text mb-2">Select a primary table (or none). You can also merge multiple tables below.</div>
                                    
                                    @if (Model.SelectedTableId.HasValue)
                                    {
                                        <div class="alert alert-success">
                                            <i class="fas fa-check-circle"></i> Table selected from dashboard: 
                                            @(Model.AvailableTables.FirstOrDefault(t => t.Id == Model.SelectedTableId)?.TableName ?? "Unknown Table")
                                        </div>
                                        <input type="hidden" asp-for="SelectedTableId" />
                                    }
                                    else
                                    {
                                        <select asp-for="TableTurnoverId" class="form-select">
                                            <option value="">-- No Table --</option>
                                            @if (Model.AvailableTables.Any())
                                            {
                                                <optgroup label="Available Tables">
                                                    @foreach (var table in Model.AvailableTables)
                                                    {
                                                        // Use negative value sentinel so POST can distinguish available (not yet seated) tables
                                                        <option value="-@table.Id">@table.TableName (Available - seats @table.Capacity)</option>
                                                    }
                                                </optgroup>
                                            }
                                            @if (Model.OccupiedTables.Any())
                                            {
                                                <optgroup label="Seated Tables">
                                                    @foreach (var table in Model.OccupiedTables)
                                                    {
                                                        <option value="@table.TurnoverId">@table.TableName - @table.GuestName (@table.PartySize guests)</option>
                                                    }
                                                </optgroup>
                                            }
                                        </select>
                                    }
                                    <span asp-validation-for="TableTurnoverId" class="text-danger"></span>
                                    <div class="mt-3" id="mergeTablesWrapper">
                                        <label class="form-label">Merge Additional Tables</label>
                                        <div class="form-text mb-2">Check any extra tables to merge into this order (capacity combined).</div>
                                        <div class="border rounded p-2" style="max-height:180px; overflow-y:auto; background:#fdfdfd;">
                                            @if (Model.AvailableTables.Any())
                                            {
                                                <div class="fw-bold small text-uppercase text-secondary mb-1">Available</div>
                                                @foreach (var table in Model.AvailableTables)
                                                {
                                                    <div class="form-check form-check-sm">
                                                        <input class="form-check-input" type="checkbox" name="SelectedTableIds" value="@table.Id" id="merge_avail_@table.Id" />
                                                        <label class="form-check-label" for="merge_avail_@table.Id">@table.TableName <span class="text-muted">(seats @table.Capacity)</span></label>
                                                    </div>
                                                }
                                            }
                                            @if (Model.OccupiedTables.Any())
                                            {
                                                <div class="fw-bold small text-uppercase text-secondary mt-2 mb-1">Seated</div>
                                                @foreach (var table in Model.OccupiedTables)
                                                {
                                                    <div class="form-check form-check-sm">
                                                        <input class="form-check-input" type="checkbox" name="SelectedTableIds" value="@table.TableId" id="merge_occ_@table.TableId" />
                                                        <label class="form-check-label" for="merge_occ_@table.TableId">@table.TableName <span class="text-muted">(@table.GuestName, @table.PartySize guests)</span></label>
                                                    </div>
                                                }
                                            }
                                            @if (!Model.AvailableTables.Any() && !Model.OccupiedTables.Any())
                                            {
                                                <div class="text-muted small">No tables found.</div>
                                            }
                                        </div>
                                    </div>
                                </div>
                                <div id="addressSection" class="mt-3 d-none">
                                    <label asp-for="CustomerAddress" class="form-label">Address</label>
                                    <textarea asp-for="CustomerAddress" class="form-control" rows="3" placeholder="Flat/House No, Street, Area, City, PIN"></textarea>
                                    <span asp-validation-for="CustomerAddress" class="text-danger"></span>
                                </div>

                                <div id="roomServiceSection" class="mt-3 d-none">
                                    <div class="mb-2 text-secondary fw-bold" style="font-size:1.1rem;">Room Service Details</div>

                                    <div class="mb-3">
                                        <label asp-for="HBranchId" class="form-label">Hotel Branch</label>
                                        <select asp-for="HBranchId" class="form-select" id="hotelBranch">
                                            <option value="">-- Select Branch --</option>
                                        </select>
                                        <span asp-validation-for="HBranchId" class="text-danger"></span>
                                    </div>

                                    <div class="mb-3">
                                        <label asp-for="RoomId" class="form-label">Room No</label>
                                        <select asp-for="RoomId" class="form-select" id="roomNo" disabled>
                                            <option value="">-- Select Room --</option>
                                        </select>
                                        <span asp-validation-for="RoomId" class="text-danger"></span>
                                    </div>

                                    <div class="mb-1">
                                        <label asp-for="HBookingNo" class="form-label">Booking No</label>
                                        <input asp-for="HBookingNo" class="form-control" id="bookingNo" placeholder="Enter booking no" />
                                        <span asp-validation-for="HBookingNo" class="text-danger"></span>
                                        <div class="form-text">Select Room or enter Booking No to auto-fill guest details.</div>
                                    </div>

                                    <input asp-for="HBookingId" type="hidden" id="bookingId" />
                                </div>
                            </div>
                            <div class="col-md-6">
                                <div class="mb-2 text-secondary fw-bold" style="font-size:1.1rem;">Special Instructions</div>
                                <label asp-for="SpecialInstructions" class="form-label">Instructions</label>
                                <textarea asp-for="SpecialInstructions" class="form-control" rows="5"></textarea>
                                <span asp-validation-for="SpecialInstructions" class="text-danger"></span>
                                
                                <div class="mt-3">
                                    <label asp-for="CustomerEmailId" class="form-label">Customer Email</label>
                                    <input asp-for="CustomerEmailId" type="email" class="form-control" placeholder="customer@example.com" />
                                    <span asp-validation-for="CustomerEmailId" class="text-danger"></span>
                                    <small class="form-text text-muted">Optional: For sending order confirmation and receipts</small>
                                </div>

                                <div id="customerSection" class="mt-3 d-none">
                                    <label asp-for="CustomerName" class="form-label">Customer Name</label>
                                    <input asp-for="CustomerName" class="form-control" />
                                    <span asp-validation-for="CustomerName" class="text-danger"></span>
                                </div>
                                <div id="phoneSection" class="mt-3 d-none">
                                    <label asp-for="CustomerPhone" class="form-label">Customer Phone</label>
                                    <input asp-for="CustomerPhone" class="form-control" />
                                    <span asp-validation-for="CustomerPhone" class="text-danger"></span>
                                </div>
                            </div>
                        </div>
                        <div class="d-flex justify-content-between mt-4">
                            <a asp-action="Dashboard" class="btn" style="background: linear-gradient(135deg, #6b7280 0%, #4b5563 100%); color: white; border: none; box-shadow: 0 4px 12px rgba(107,114,128,.3);">Cancel</a>
                            <button type="submit" class="btn text-white px-4" style="background: linear-gradient(135deg, #3b82f6 0%, #06b6d4 100%); border: none; box-shadow: 0 4px 15px rgba(59,130,246,.4);">
                                <i class="fas fa-plus-circle"></i> Create Order
                                <span class="badge ms-2" style="background: rgba(255,255,255,.2); backdrop-filter: blur(10px); color: white; font-size: 0.7rem; font-weight: 500; border: 1px solid rgba(255,255,255,.3);">Ctrl+O</span>
                            </button>
                        </div>
                    </form>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <script>
        $(function () {
            var roomServiceRooms = [];

            function hasServerValidationErrors() {
                // Razor validation summary emits this class when ModelState invalid
                return $('.validation-summary-errors').length > 0;
            }

            function focusIfVisible(selector) {
                var $el = $(selector);
                if ($el.length === 0) return false;
                if ($el.is(':disabled')) return false;
                if ($el.is(':visible')) {
                    $el.trigger('focus');
                    return true;
                }
                return false;
            }

            function toggleTableSection() {
                var orderType = $('#orderType').val();
                if (orderType === '0') {
                    $('#tableSection').removeClass('d-none');
                    $('#customerSection, #phoneSection').removeClass('d-none');
                    $('#addressSection').addClass('d-none');
                    $('#roomServiceSection').addClass('d-none');
                    $('#mergeTablesWrapper').removeClass('d-none');
                } else {
                    $('#tableSection').addClass('d-none');
                    $('#customerSection, #phoneSection').removeClass('d-none');
                    // Show address only for Delivery
                    if (orderType === '2') {
                        $('#addressSection').removeClass('d-none');
                    } else {
                        $('#addressSection').addClass('d-none');
                    }
                    // Show room service fields only for Room Service (foods order create)
                    if (orderType === '4') {
                        $('#roomServiceSection').removeClass('d-none');
                    } else {
                        $('#roomServiceSection').addClass('d-none');
                    }
                    $('#mergeTablesWrapper').addClass('d-none');
                }
            }

            function autoFocusNextField() {
                // Don't override when returning with server-side validation errors
                if (hasServerValidationErrors()) return;

                var orderType = $('#orderType').val();

                if (orderType === '0') {
                    // Dine-In: prefer table selection if required
                    var hasHidden = $('input[name="SelectedTableId"]').val();
                    var dropdownVal = $('#TableTurnoverId').val();
                    if (!hasHidden && (!dropdownVal || dropdownVal === '')) {
                        if (focusIfVisible('#TableTurnoverId')) return;
                    }
                    // Otherwise, focus customer name for quick entry
                    if (focusIfVisible('#CustomerName')) return;
                    focusIfVisible('#CustomerPhone');
                    return;
                }

                if (orderType === '2') {
                    // Delivery: address is required
                    if (focusIfVisible('#CustomerAddress')) return;
                    if (focusIfVisible('#CustomerPhone')) return;
                    focusIfVisible('#CustomerName');
                    return;
                }

                if (orderType === '4') {
                    // Room Service: branch is required
                    ensureBranchesLoaded();
                    if (focusIfVisible('#hotelBranch')) return;
                    if (focusIfVisible('#roomNo')) return;
                    focusIfVisible('#bookingNo');
                    return;
                }

                // Takeout/others: phone is usually fastest identifier
                if (focusIfVisible('#CustomerPhone')) return;
                focusIfVisible('#CustomerName');
            }

            function resetRoomServiceState() {
                roomServiceRooms = [];
                $('#hotelBranch').val('');
                $('#roomNo').prop('disabled', true).html('<option value="">-- Select Room --</option>');
                $('#bookingNo').prop('readonly', false).val('');
                $('#bookingId').val('');
                $('#CustomerName').val('');
                $('#CustomerPhone').val('');
            }

            function ensureBranchesLoaded() {
                if ($('#hotelBranch option').length > 1) return;
                $.getJSON('/Order/GetHotelBranches')
                    .done(function (res) {
                        if (!res || res.success !== true) return;
                        var opts = '<option value="">-- Select Branch --</option>';
                        (res.data || []).forEach(function (b) {
                            opts += '<option value="' + b.branchId + '">' + b.branch + '</option>';
                        });
                        $('#hotelBranch').html(opts);
                    });
            }

            function loadRooms(branchId) {
                $('#roomNo').prop('disabled', true).html('<option value="">Loading...</option>');
                $('#bookingNo').prop('readonly', false);
                $('#bookingId').val('');
                roomServiceRooms = [];

                $.getJSON('/Order/GetCheckedInOccupiedRooms', { branchId: branchId })
                    .done(function (res) {
                        if (!res || res.success !== true) {
                            $('#roomNo').prop('disabled', true).html('<option value="">-- Select Room --</option>');
                            return;
                        }
                        roomServiceRooms = res.data || [];
                        var opts = '<option value="">-- Select Room --</option>';
                        roomServiceRooms.forEach(function (r) {
                            var label = (r.roomNo || '') + (r.guestName ? (' - ' + r.guestName) : '');
                            opts += '<option value="' + r.roomId + '" data-bookingno="' + (r.bookingNo || '') + '">' + label + '</option>';
                        });
                        $('#roomNo').html(opts).prop('disabled', false);
                    })
                    .fail(function () {
                        $('#roomNo').prop('disabled', true).html('<option value="">-- Select Room --</option>');
                    });
            }

            function applyRoomBookingData(roomRow) {
                if (!roomRow) return;

                $('#roomNo').val(String(roomRow.roomId || ''));
                // Use readonly (not disabled) so the value is still posted in form submit
                $('#bookingNo').val(roomRow.bookingNo || '').prop('readonly', true);
                $('#bookingId').val(roomRow.bookingId || '');

                // Map guest to existing fields
                $('#CustomerName').val(roomRow.guestName || '');
                $('#CustomerPhone').val(roomRow.guestPhone || '');
                if (roomRow.guestEmailId && $('#CustomerEmailId').val().trim().length === 0) {
                    $('#CustomerEmailId').val(roomRow.guestEmailId);
                }
            }

            function tryResolveByBookingNo(bookingNo) {
                var bn = (bookingNo || '').trim();
                if (!bn) return;
                var match = roomServiceRooms.find(function (r) { return (r.bookingNo || '').toLowerCase() === bn.toLowerCase(); });
                if (match) {
                    applyRoomBookingData(match);
                } else {
                    // Allow manual booking entry if not found
                    $('#bookingId').val('');
                    $('#bookingNo').prop('readonly', false);
                }
            }

            function resolvePrimaryTableId() {
                // Priority: hidden SelectedTableId (coming from dashboard) else dropdown value
                var hidden = $('input[name="SelectedTableId"]').val();
                if (hidden) return hidden; // Already actual TableId
                var dropdownVal = $('#TableTurnoverId').val();
                if (!dropdownVal) return null;
                // Available tables prefixed with '-' so strip it
                if (dropdownVal.startsWith('-')) return dropdownVal.substring(1);
                // For occupied seated tables, the value is turnover id; we have checkboxes with actual tableId values.
                // We attempt to find a checkbox whose id ends with that turnover id pattern if mapping exists; fallback using same value.
                return dropdownVal; 
            }

            function updateMergeTableOptions() {
                // Enable all first
                var $all = $('input[name="SelectedTableIds"]').prop('disabled', false).closest('.form-check').removeClass('text-muted');
                var primaryId = resolvePrimaryTableId();
                if (primaryId) {
                    var $cb = $('input[name="SelectedTableIds"][value="' + primaryId + '"]');
                    if ($cb.length) {
                        $cb.prop('disabled', true).prop('checked', false).closest('.form-check').addClass('text-muted');
                    }
                }
            }

            // Handlers
            $('#orderType').on('change', function(){ toggleTableSection(); updateMergeTableOptions(); autoFocusNextField(); });
            $('#TableTurnoverId').on('change', updateMergeTableOptions);

            // Room service handlers
            $('#orderType').on('change', function () {
                if ($('#orderType').val() === '4') {
                    ensureBranchesLoaded();
                } else {
                    resetRoomServiceState();
                }
            });

            $('#hotelBranch').on('change', function () {
                var branchId = $(this).val();
                $('#bookingNo').val('').prop('readonly', false);
                $('#bookingId').val('');
                $('#roomNo').val('');
                if (!branchId) {
                    $('#roomNo').prop('disabled', true).html('<option value="">-- Select Room --</option>');
                    roomServiceRooms = [];
                    return;
                }
                loadRooms(branchId);
            });

            $('#roomNo').on('change', function () {
                var roomId = $(this).val();
                if (!roomId) {
                    $('#bookingNo').val('').prop('readonly', false);
                    $('#bookingId').val('');
                    return;
                }
                var match = roomServiceRooms.find(function (r) { return String(r.roomId) === String(roomId); });
                applyRoomBookingData(match);
            });

            $('#bookingNo').on('blur', function () {
                if ($('#orderType').val() !== '4') return;
                tryResolveByBookingNo($('#bookingNo').val());
            });

            // Form submit validation
            $('form').on('submit', function(e){
                if ($('#orderType').val() === '0') { // dine-in
                    var hasHidden = $('input[name="SelectedTableId"]').val();
                    var dropdownVal = $('#TableTurnoverId').val();
                    if (!hasHidden && (!dropdownVal || dropdownVal === '')) {
                        e.preventDefault();
                        $('.alert-danger.table-validation').remove();
                        var alertHtml = '<div class="alert alert-danger alert-dismissible fade show table-validation" role="alert">' +
                            '<i class="fas fa-exclamation-triangle me-2"></i><strong>Primary Table Required!</strong> Please select a primary table for Dine-In orders.' +
                            '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
                        $('form .row').first().before(alertHtml);
                        $('html, body').animate({ scrollTop: $(document).find('.alert-danger.table-validation').offset().top - 100 }, 400);
                        $('#TableTurnoverId').focus();
                        return false;
                    }
                    } else if ($('#orderType').val() === '2') { // delivery
                        var addr = $.trim($('#CustomerAddress').val() || '');
                        if (addr.length === 0) {
                            e.preventDefault();
                            $('.alert-danger.addr-validation').remove();
                            var alertHtml2 = '<div class="alert alert-danger alert-dismissible fade show addr-validation" role="alert">' +
                                '<i class="fas fa-map-marker-alt me-2"></i><strong>Address Required!</strong> Please enter delivery address.' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
                            $('form .row').first().before(alertHtml2);
                            $('html, body').animate({ scrollTop: $(document).find('.alert-danger.addr-validation').offset().top - 100 }, 400);
                            $('#CustomerAddress').focus();
                            return false;
                        }
                } else if ($('#orderType').val() === '4') { // room service
                        var branchId = $('#hotelBranch').val();
                        var roomId = $('#roomNo').val();
                        var bookingNo = $.trim($('#bookingNo').val() || '');
                        if (!branchId) {
                            e.preventDefault();
                            $('.alert-danger.rs-validation').remove();
                            var a1 = '<div class="alert alert-danger alert-dismissible fade show rs-validation" role="alert">' +
                                '<i class="fas fa-exclamation-triangle me-2"></i><strong>Hotel Branch Required!</strong> Please select hotel branch.' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
                            $('form .row').first().before(a1);
                            $('html, body').animate({ scrollTop: $(document).find('.alert-danger.rs-validation').offset().top - 100 }, 400);
                            $('#hotelBranch').focus();
                            return false;
                        }
                        if (!roomId && bookingNo.length === 0) {
                            e.preventDefault();
                            $('.alert-danger.rs-validation').remove();
                            var a2 = '<div class="alert alert-danger alert-dismissible fade show rs-validation" role="alert">' +
                                '<i class="fas fa-exclamation-triangle me-2"></i><strong>Room/Booking Required!</strong> Select room or enter booking no.' +
                                '<button type="button" class="btn-close" data-bs-dismiss="alert" aria-label="Close"></button></div>';
                            $('form .row').first().before(a2);
                            $('html, body').animate({ scrollTop: $(document).find('.alert-danger.rs-validation').offset().top - 100 }, 400);
                            $('#roomNo').focus();
                            return false;
                        }
                        // If bookingNo entered but no roomId matched, allow submission (backend will validate)
                }
                return true;
            });

            // Initial load
            toggleTableSection();
            updateMergeTableOptions();
            if ($('#orderType').val() === '4') {
                ensureBranchesLoaded();
            }

            // Autofocus after initial UI is in correct state
            autoFocusNextField();
        });
    </script>
}
