@model OrderViewModel
@{
    ViewData["Title"] = "Order Details";
}
@section Styles {
  <style>
    /* Ensure top nav dropdowns appear above sticky side panels on order details page */
    .navbar { z-index: 2000 !important; }
    #orderDetailsApp .sticky-top { z-index: 100; }
    /* Defensive: allow dropdown menus to overflow visible area */
    .navbar .dropdown-menu { position: absolute; }
    /* Disabled anchor-style buttons (payment link) */
    .btn-disabled { pointer-events: none; opacity: 0.65; cursor: default !important; }
    /* Page watermark when order fully paid */
    .page-watermark {
      position: absolute;
      top: 50%;
      left: 50%;
      transform: translate(-50%, -50%) rotate(-18deg);
      pointer-events: none;
      user-select: none;
      z-index: 50; /* lower so it does not fully obscure UI controls */
      -webkit-print-color-adjust: exact;
      display: flex;
      align-items: center;
      justify-content: center;
      opacity: 0.55; /* overall subtle opacity */
    }
    .page-watermark .watermark-circle {
      width: 220px; /* smaller, less intrusive */
      height: 220px;
      border-radius: 50%;
      border: 6px solid rgba(220,20,60,0.12); /* very soft red ring */
      background: rgba(255,255,255,0.0);
      display: flex;
      align-items: center;
      justify-content: center;
      box-shadow: 0 4px 12px rgba(0,0,0,0.03) inset;
    }
    .page-watermark .watermark-circle span {
      display: block;
      color: rgba(220,20,60,0.35); /* faint red text */
      font-size: 2.6rem;
      font-weight: 800;
      letter-spacing: 0.08em;
      transform: translateY(4px); /* slight vertical adjustment */
    }
    @@media (max-width: 768px) {
      .page-watermark .watermark-circle { width: 160px; height: 160px; border-width: 5px; }
      .page-watermark .watermark-circle span { font-size: 1.8rem; }
      .page-watermark { top: 50%; }
    }
    /* Hide watermark when printing header/footer areas might overlap; keep visible on print */
    @@media print {
      /* For print, keep it visible but still subtle */
      .page-watermark .watermark-circle { width: 320px; height: 320px; border-width: 10px; }
      .page-watermark .watermark-circle span { font-size: 4.2rem; color: rgba(200,0,0,0.45); }
    }
    /* Deep blue color for Order # */
    .order-number-text {
      color: #003d82;
      font-weight: 600;
    }
    /* Colorful Order Summary styling */
    .order-summary-card .card-header {
      background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
      color: white;
      font-weight: 600;
    }
    .order-summary-card .card-body {
      background: linear-gradient(to bottom, #f8f9ff 0%, #ffffff 100%);
    }
    .order-summary-card dt {
      color: #5a67d8;
      font-weight: 600;
    }
    .order-summary-card dd {
      color: #2d3748;
      font-weight: 500;
    }

    /* Denser order items table for high-throughput usage */
    #orderItemsTable.table-sm > :not(caption) > * > * { padding: 0.32rem 0.5rem; }
    #orderItemsTable .item-note, #orderItemsTable .item-qty { height: calc(1.5em + .5rem + 2px); padding-top: .2rem; padding-bottom: .2rem; }
    #orderItemsTable .existing-item-row td { vertical-align: top; }

    /* Mobile sticky totals strip */
    #mobileStickyTotals {
      position: sticky;
      bottom: 0;
      z-index: 1100;
      background: #fff;
      border-top: 1px solid rgba(0,0,0,0.08);
      padding: .5rem .75rem;
    }
    @@media (min-width: 992px) {
      #mobileStickyTotals { display: none; }
    }

    /* Order Details action bar alignment */
    #orderPrimaryActions { align-items: center; }
    #orderPrimaryActions .btn,
    #orderPrimaryActions a.btn {
      display: inline-flex;
      align-items: center;
      gap: 0.35rem;
      white-space: nowrap;
      min-height: 32px;
    }
    #orderPrimaryActions .btn .badge,
    #orderPrimaryActions a.btn .badge { line-height: 1; }
    #orderPrimaryActions .action-meta {
      display: inline-flex;
      align-items: center;
      gap: 0.5rem;
      white-space: nowrap;
    }
    #orderPrimaryActions #orderSaveState { white-space: nowrap; }
  </style>
}
@{
  var isFullyPaid = Model.IsFullyPaid;
  var paymentClass = "btn btn-sm btn-success" + (isFullyPaid ? " btn-disabled" : "");
  var isBarOrder = ViewBag.IsBarOrder ?? false;
  var fireButtonLabel = isBarOrder ? "Fire To Bar" : "Fire To Kitchen";
  var fireButtonIcon = isBarOrder ? "fa-cocktail" : "fa-fire";
  var kotPrintLabel = isBarOrder ? "BOT Print" : "KOT Print";
  var isPaymentPartiallyPaid = !isFullyPaid && (Model.PaidAmount > 0m || Model.RemainingAmount > 0m) && Model.PaidAmount > 0m;
  var paymentBadgeText = isFullyPaid ? "Paid" : isPaymentPartiallyPaid ? "Partially Paid" : "Unpaid";
  var paymentBadgeClass = isFullyPaid ? "bg-success" : isPaymentPartiallyPaid ? "bg-warning text-dark" : "bg-danger";
  var hasTickets = Model.KitchenTickets != null && Model.KitchenTickets.Any();
  var hasPendingToFire = Model.Items != null && Model.Items.Any(i => i.Status == 0);
  var kotBadgeText = isBarOrder ? "BOT" : "KOT";
}
<div class="container-fluid py-3 position-relative" id="orderDetailsApp" data-order-id="@Model.Id" data-is-fully-paid="@isFullyPaid.ToString().ToLower()"  data-is-bar-order="@isBarOrder.ToString().ToLower()">
  @if (isFullyPaid)
  {
    <div class="page-watermark" aria-hidden="true">
      <div class="watermark-circle"><span>PAID</span></div>
    </div>
  }
  <div class="row g-3">
    <div class="col-lg-8 col-12">
      <div class="d-flex flex-wrap align-items-center gap-2 mb-2">
        <form id="orderItemAddForm" class="row row-cols-auto g-2 align-items-end flex-grow-1" autocomplete="off">
          @Html.AntiForgeryToken()
          <input type="hidden" id="orderId" value="@Model.Id" />
            <div class="col" style="min-width:200px;">
            <label for="menuItemGroupSelect" class="form-label small mb-1 fw-semibold">Item Group</label>
            <select id="menuItemGroupSelect" class="form-select form-select-sm" disabled>
                @if (Model.MenuItemGroups != null && Model.MenuItemGroups.Any())
                {
                    foreach (var g in Model.MenuItemGroups)
                    {
                    var itemGroupDisplayName = string.Equals(g.ItemGroup, "Foods", StringComparison.OrdinalIgnoreCase) ? "General"
                      : string.Equals(g.ItemGroup, "Bar", StringComparison.OrdinalIgnoreCase) ? "Others"
                      : g.ItemGroup;
                        if (g.ID == Model.SelectedMenuItemGroupId)
                        {
                      <option value="@g.ID" selected>@itemGroupDisplayName</option>
                        }
                        else
                        {
                      <option value="@g.ID">@itemGroupDisplayName</option>
                        }
                    }
                }
                else
                {
                    <option value="1" selected>Default</option>
                }
            </select>
          </div>
            <div class="col flex-grow-1" style="min-width:200px;">
            <label for="menuItemInput" class="form-label small mb-1 fw-semibold">Menu Item <span class="badge bg-secondary" style="font-size: 0.65rem;">Space</span></label>
            <input list="menuItems" id="menuItemInput" class="form-control form-control-sm" placeholder="Search menu (name)..." required disabled="@(isFullyPaid ? "disabled" : null)" />
            <datalist id="menuItems">
                @foreach (var mi in Model.AvailableMenuItems)
                {
                    var displayPrice = Model.OrderType == 1 ? (mi.TakeoutPrice ?? mi.Price) :
                                      (Model.OrderType == 4) ? (mi.RoomServicePrice ?? mi.DeliveryPrice ?? mi.Price) :
                                      (Model.OrderType == 2 || Model.OrderType == 3) ? (mi.DeliveryPrice ?? mi.Price) :
                                      mi.Price;
                  <option value="@mi.Name" data-id="@mi.Id" data-price="@displayPrice.ToString("F2")" data-plu="@mi.PLUCode">@mi.PLUCode - @mi.Name (₹@displayPrice.ToString("F2"))</option>
                }
            </datalist>
          </div>
          <div class="col">
            <label for="menuItemQty" class="form-label small mb-1 fw-semibold">Qty <span class="badge bg-secondary" style="font-size: 0.65rem;">Enter</span></label>
            <input type="number" id="menuItemQty" class="form-control form-control-sm" min="1" value="1" required />
          </div>
            <div class="col">
              <button type="submit" class="btn btn-sm btn-primary" id="addItemBtn" disabled="@(isFullyPaid ? "disabled" : null)">
                <i class="fas fa-plus"></i> Add <span class="badge bg-light text-dark" style="font-size: 0.65rem;">Enter</span>
              </button>
            </div>
        </form>
        <div class="ms-auto d-flex flex-wrap align-items-center justify-content-end gap-2" id="orderPrimaryActions">
          <div class="btn-group" role="group" aria-label="Kitchen actions">
            <button type="button" id="fireItemsBtn" class="btn btn-sm btn-outline-warning" data-bs-toggle="modal" data-bs-target="#fireItemsModal">
              <i class="fas @fireButtonIcon"></i> @fireButtonLabel <span class="badge bg-warning text-dark" style="font-size: 0.65rem;">Ctrl+F</span>
            </button>
            @{ var hasKOT = Model.KitchenTickets != null && Model.KitchenTickets.Any(); }
            <a asp-action="KOTBill" asp-route-id="@Model.Id" class="btn btn-sm btn-outline-info @(hasKOT ? "" : "btn-disabled")" title="@kotPrintLabel" target="_blank" rel="noopener noreferrer" aria-disabled="@(hasKOT? "false" : "true")"> <i class="fas fa-print"></i> @kotPrintLabel</a>
          </div>

          <div class="btn-group" role="group" aria-label="Order actions">
            <button id="saveOrderBtn" class="btn btn-sm btn-primary" disabled="@(isFullyPaid ? "disabled" : null)">
              <i class="fas fa-save"></i> Save <span class="badge bg-light text-dark" style="font-size: 0.65rem;">Ctrl+S</span>
            </button>
            <a id="paymentBtn" asp-controller="Payment" asp-action="Index" asp-route-id="@Model.Id" asp-route-fromBar="@(isBarOrder ? "true" : null)" class="@paymentClass" aria-disabled="@(isFullyPaid ? "true" : null)" tabindex="@(isFullyPaid ? "-1" : null)">
              <i class="fas fa-credit-card"></i> Payment <span class="badge bg-light text-dark" style="font-size: 0.65rem;">Ctrl+P</span>
            </a>
          </div>

          <div class="action-meta">
            <span id="orderSaveState" class="small text-muted">Saved @Model.UpdatedAt.ToString("t")</span>
            <span id="paymentRequirementsMsg" class="small text-danger d-none"></span>
          </div>

          <div class="btn-group" role="group" aria-label="Navigation">
            @if (ViewBag.IsBarOrder == true)
            {
              <a asp-controller="BOT" asp-action="BarOrderDashboard" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
            }
            else
            {
              <a asp-action="Dashboard" class="btn btn-sm btn-outline-secondary"><i class="fas fa-arrow-left"></i> Back</a>
            }
          </div>
        </div>
      </div>
      <div class="card shadow-sm mb-3">
        <div class="card-header d-flex justify-content-between align-items-center py-2">
          <div class="small"><strong class="order-number-text">Order #:</strong> <span class="order-number-text">@Model.OrderNumber</span> <span class="badge bg-secondary ms-2">@Model.StatusDisplay</span></div>
          <span class="small text-muted">Edit items, then Save</span>
        </div>
        <div class="card-body p-0">
                    <div class="table-responsive">
            <table class="table table-sm table-hover align-middle mb-0" id="orderItemsTable">
          <thead style="background: linear-gradient(135deg, #667eea 0%, #764ba2 100%); color: white;">
            <tr>
              <th style="width:50px"><input type="checkbox" id="selectAllFire" /></th>
              <th>Item</th>
              <th style="width:90px" class="text-center">Qty</th>
              <th style="width:110px" class="text-end">Unit</th>
              <th style="width:120px" class="text-end">Subtotal</th>
              <th style="width:110px">Status</th>
              <th style="width:70px"></th>
            </tr>
          </thead>
          <tbody id="orderItemsBody">
            @foreach (var it in Model.Items.Where(i=> i.Status != 5))
            {
              var isEditableLine = !isFullyPaid && it.Status == 0;
              <tr data-order-item-id="@it.Id" data-menu-item-id="@it.MenuItemId" data-item-status="@it.Status" class="existing-item-row">
                <td class="text-center"><input type="checkbox" class="fire-select" value="@it.Id" /></td>
                <td>
                  <div class="fw-semibold">@it.MenuItemName</div>
                  <div class="mt-1">
                    <input type="text" class="form-control form-control-sm item-note" value="@it.SpecialInstructions" placeholder="Note" @(isEditableLine ? "" : "disabled") />
                  </div>
                  @if (it.KitchenComments?.Any() == true)
                  {
                    <div class="mt-2 small">
                      <div class="fw-semibold text-muted">Kitchen Comments</div>
                      <ul class="list-unstyled mb-0">
                        @foreach (var c in it.KitchenComments.OrderByDescending(c => c.CreatedAt).Take(5))
                        {
                          <li class="border rounded p-2 mb-1 bg-light">
                            <div class="d-flex justify-content-between">
                              <span class="fw-semibold">@(string.IsNullOrWhiteSpace(c.CreatedByName) ? "Kitchen" : c.CreatedByName)</span>
                              <span class="text-muted" style="font-size:.75rem;">@c.CreatedAt.ToLocalTime().ToString("g")</span>
                            </div>
                            <div>@Html.Raw(System.Net.WebUtility.HtmlEncode(c.CommentText).Replace("\r\n", "<br/>").Replace("\n", "<br/>"))</div>
                          </li>
                        }
                      </ul>
                    </div>
                  }
                </td>
                <td class="text-center"><input type="number" class="form-control form-control-sm item-qty" value="@it.Quantity" min="1" @(isEditableLine ? "" : "disabled") /></td>
                <td class="text-end">₹@it.UnitPrice.ToString("F2")</td>
                <td class="text-end subtotal-cell">₹@it.Subtotal.ToString("F2")</td>
                <td><span class="badge bg-@(it.Status==0?"primary":it.Status==1?"warning text-dark":it.Status==2?"info":it.Status==3?"success":"secondary")">@it.StatusDisplay</span></td>
                <td class="text-end">
                  @if(!isFullyPaid && it.Status == 0){
                    <button type="button" class="btn btn-outline-danger btn-sm remove-existing"><i class="fas fa-times"></i></button>
                  }
                </td>
              </tr>
            }
          </tbody>
          <tfoot class="table-light">
            <tr>
              <td colspan="4" class="text-end fw-semibold">Subtotal:</td>
              <td colspan="3" class="text-end" id="orderSubtotalCell" data-total="subtotal">₹@Model.Subtotal.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end">GST (@Model.GSTPercentage.ToString("F2")%):</td>
              <td colspan="3" class="text-end" id="orderTaxCell" data-total="tax">₹@Model.TaxAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;CGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.CGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end small text-muted">&nbsp;&nbsp;SGST (@( (Model.GSTPercentage/2).ToString("F2") )%):</td>
              <td colspan="3" class="text-end small text-muted">₹@Model.SGSTAmount.ToString("F2")</td>
            </tr>
            <tr>
              <td colspan="4" class="text-end fw-semibold">Total:</td>
              <td colspan="3" class="text-end fw-bold" id="orderTotalCell" data-total="total">₹@Model.TotalAmount.ToString("F2")</td>
            </tr>
          </tfoot>
            </table>
          </div>
        </div>
      </div>
    </div>
    <div class="col-lg-4 col-12">
      <div class="sticky-top" style="top:1rem;">
        <div class="card mb-3 shadow-sm order-summary-card">
          <div class="card-header py-2"><i class="fas fa-info-circle me-1"></i> Order Summary</div>
          <div class="card-body small">
            <div class="d-flex flex-wrap gap-2 mb-2">
              <span class="badge @paymentBadgeClass">@paymentBadgeText</span>
              @if (hasTickets)
              {
                <span class="badge bg-primary">@kotBadgeText sent</span>
              }
              @if (hasPendingToFire)
              {
                <span class="badge bg-warning text-dark">@kotBadgeText pending</span>
              }
              <span class="badge bg-light text-dark border">Updated @Model.UpdatedAt.ToString("t")</span>
            </div>
            <dl class="row mb-0">
              <dt class="col-5">Customer</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerName)?Model.CustomerName: (string.IsNullOrEmpty(Model.GuestName)?"—":Model.GuestName))</dd>
              <dt class="col-5">Phone</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerPhone)?Model.CustomerPhone:"—")</dd>
              <dt class="col-5">Email</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.CustomerEmailId)?Model.CustomerEmailId:"—")</dd>
              @if (Model.OrderType == 2 && !string.IsNullOrWhiteSpace(Model.CustomerAddress))
              {
                <dt class="col-5">Address</dt><dd class="col-7">@Model.CustomerAddress</dd>
              }
              <dt class="col-5">Table</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.TableName)?Model.TableName:"—")</dd>
              <dt class="col-5">Server</dt><dd class="col-7">@(!string.IsNullOrEmpty(Model.ServerName)?Model.ServerName:"—")</dd>
              <dt class="col-5">Type</dt><dd class="col-7">@Model.OrderTypeDisplay</dd>
              @if (Model.OrderType == 4)
              {
                <dt class="col-5">Room No</dt><dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.RoomNo) ? Model.RoomNo : (Model.RoomId.HasValue ? Model.RoomId.Value.ToString() : "—"))</dd>
                <dt class="col-5">Booking No</dt><dd class="col-7">@(!string.IsNullOrWhiteSpace(Model.HBookingNo) ? Model.HBookingNo : "—")</dd>
              }
              <dt class="col-5">Created</dt><dd class="col-7">@Model.CreatedAt.ToString("g")</dd>
              <dt class="col-5">Last Updated</dt><dd class="col-7">@Model.UpdatedAt.ToString("g")</dd>
            </dl>
          </div>
        </div>
        <div class="card mb-3 shadow-sm" style="border-left: 4px solid #10b981;">
          <div class="card-header py-2" style="background: linear-gradient(135deg, #10b981 0%, #059669 100%); color: white;"><i class="fas fa-sticky-note me-1"></i> Order Note</div>
          <div class="card-body small">
            @if(!string.IsNullOrWhiteSpace(Model.SpecialInstructions)){
              <div class="text-muted">@Model.SpecialInstructions</div>
            } else { <div class="text-muted fst-italic">No note provided.</div> }
          </div>
        </div>
        <div class="card shadow-sm" style="border-left: 4px solid #f59e0b;">
          <div class="card-header py-2" style="background: linear-gradient(135deg, #f59e0b 0%, #d97706 100%); color: white;"><i class="fas fa-receipt me-1"></i> Totals</div>
          <div class="card-body p-2">
            <table class="table table-sm mb-0">
              <tbody class="small">
                <tr><td class="text-muted">Subtotal</td><td class="text-end" id="orderSubtotalCellSide" data-total="subtotal">₹@Model.Subtotal.ToString("F2")</td></tr>
                <tr><td class="text-muted">GST (@Model.GSTPercentage.ToString("F2")%)</td><td class="text-end" id="orderTaxCellSide" data-total="tax">₹@Model.TaxAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">CGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.CGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted small ps-3">SGST (@( (Model.GSTPercentage/2).ToString("F2") )%)</td><td class="text-end small">₹@Model.SGSTAmount.ToString("F2")</td></tr>
                <tr><td class="text-muted">Discount</td><td class="text-end">₹@Model.DiscountAmount.ToString("F2")</td></tr>
                <tr class="table-light"><th>Total</th><th class="text-end" id="orderTotalCellSide" data-total="total">₹@Model.TotalAmount.ToString("F2")</th></tr>
              </tbody>
            </table>
          </div>
        </div>
      </div>
    </div>
  </div>

  <div id="mobileStickyTotals" class="d-lg-none">
    <div class="d-flex justify-content-between align-items-center">
      <div class="small text-muted">Subtotal: <span class="fw-semibold" id="orderSubtotalCellMobile">₹@Model.Subtotal.ToString("F2")</span></div>
      <div class="small">Total: <span class="fw-bold" id="orderTotalCellMobile">₹@Model.TotalAmount.ToString("F2")</span></div>
    </div>
  </div>
  @if (Model.Items.Any(i=>i.Status==0))
  {
    <div class="modal fade" id="fireItemsModal" tabindex="-1" aria-hidden="true">
      <div class="modal-dialog">
        <div class="modal-content">
          <form id="fireItemsForm" asp-action="FireItems" method="post">
            @Html.AntiForgeryToken()
            <input type="hidden" name="OrderId" value="@Model.Id" />
            <input type="hidden" name="IsBarOrder" value="@isBarOrder.ToString().ToLower()" />
            <div class="modal-header"><h5 class="modal-title">@(isBarOrder ? "Send Items To Bar" : "Send Items To Kitchen")</h5><button type="button" class="btn-close" data-bs-dismiss="modal"></button></div>
            <div class="modal-body">
              <div class="mb-2 d-flex justify-content-between align-items-center">
                <span class="small text-muted">Select which un-fired items to send.</span>
                <div class="form-check form-check-sm">
                  <input type="checkbox" class="form-check-input" id="fireSelectAll" />
                  <label for="fireSelectAll" class="form-check-label small">All</label>
                </div>
              </div>
              <div class="list-group small" style="max-height:260px;overflow:auto;">
                @foreach (var ni in Model.Items.Where(i=>i.Status==0))
                {
                  <label class="list-group-item d-flex align-items-center gap-2 py-1">
                    <input type="checkbox" class="form-check-input fire-item-checkbox" value="@ni.Id" name="SelectedItems" />
                    <span class="flex-grow-1 d-flex justify-content-between align-items-center">
                      <span>@ni.MenuItemName</span>
                      <span class="badge bg-light text-dark border" style="font-weight:500;">x @ni.Quantity</span>
                    </span>
                  </label>
                }
                @if(!Model.Items.Any(i=>i.Status==0)){
                  <div class="text-muted fst-italic px-2 py-1">No pending items to fire.</div>
                }
              </div>
            </div>
            <div class="modal-footer"><button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button><button type="submit" class="btn btn-primary"><i class="fas fa-fire"></i> Send To Kitchen</button></div>
          </form>
        </div>
      </div>
    </div>
  }
</div>

@section Scripts {
  <script src="~/js/order-modern.js"></script>
  <script>
    (function() {
      // Manage Save and Payment button states smoothly on the Order Details page
      function $(sel, ctx) { return (ctx || document).querySelector(sel); }
      function $all(sel, ctx) { return Array.from((ctx || document).querySelectorAll(sel)); }

      const saveBtn = document.getElementById('saveOrderBtn');
      const itemsBody = document.getElementById('orderItemsBody');
      const paymentBtn = document.getElementById('paymentBtn') || document.querySelector('a[href*="/Payment/Index/"]');
      const fireBtn = document.getElementById('fireItemsBtn');
      const orderApp = document.getElementById('orderDetailsApp');
      const isFullyPaid = orderApp ? (orderApp.dataset.isFullyPaid === 'true') : false;
      const saveStateEl = document.getElementById('orderSaveState');
      const paymentReqEl = document.getElementById('paymentRequirementsMsg');
      const lastSavedIso = '@Model.UpdatedAt.ToString("o")';
      let isDirty = false;

      function setSaveEnabled(enabled) {
        if (!saveBtn) return;
        saveBtn.disabled = !enabled;
        // When there are unsaved changes, disable Payment until saved
        if (enabled) {
          setPaymentEnabled(false);
        }
      }

      function setPaymentEnabled(enabled) {
        if (!paymentBtn) return;
        if (enabled) {
          paymentBtn.classList.remove('btn-disabled');
          paymentBtn.removeAttribute('aria-disabled');
          paymentBtn.style.pointerEvents = '';
        } else {
          paymentBtn.classList.add('btn-disabled');
          paymentBtn.setAttribute('aria-disabled', 'true');
          paymentBtn.style.pointerEvents = 'none';
        }
      }

      function updateSaveStateUI() {
        if (!saveStateEl) return;
        if (isDirty) {
          saveStateEl.textContent = 'Unsaved changes';
          saveStateEl.classList.remove('text-muted');
          saveStateEl.classList.add('text-warning');
        } else {
          const d = lastSavedIso ? new Date(lastSavedIso) : null;
          const timeText = (d && !isNaN(d.getTime())) ? d.toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' }) : '';
          saveStateEl.textContent = timeText ? `Saved ${timeText}` : 'Saved';
          saveStateEl.classList.remove('text-warning');
          saveStateEl.classList.add('text-muted');
        }
      }

      function computePaymentRequirements() {
        const missing = [];

        // Customer is optional (do not block payment when missing)

        // Table + Server required for dine-in (OrderType == 0)
        if (@Model.OrderType == 0) {
          const tableText = '@(Model.TableName ?? "")';
          const serverText = '@(Model.ServerName ?? "")';
          if (!tableText || tableText.trim().length === 0) missing.push('table');
          if (!serverText || serverText.trim().length === 0) missing.push('server');
        }

        return missing;
      }

      function applyPaymentRequirementsUI() {
        const missing = computePaymentRequirements();
        if (!paymentReqEl) return missing.length === 0;

        if (missing.length === 0) {
          paymentReqEl.classList.add('d-none');
          paymentReqEl.textContent = '';
          return true;
        }

        paymentReqEl.classList.remove('d-none');
        paymentReqEl.textContent = `Payment disabled: missing ${missing.join(', ')}`;
        setPaymentEnabled(false);
        return false;
      }

      function setFireEnabled(enabled) {
        if (!fireBtn) return;
        if (enabled) {
          fireBtn.classList.remove('disabled');
          fireBtn.removeAttribute('disabled');
          fireBtn.setAttribute('aria-disabled', 'false');
          fireBtn.style.pointerEvents = '';
        } else {
          fireBtn.classList.add('disabled');
          fireBtn.setAttribute('disabled', 'disabled');
          fireBtn.setAttribute('aria-disabled', 'true');
          fireBtn.style.pointerEvents = 'none';
        }
      }

      function hasSavedItems() {
        // saved items are rendered as rows with class 'existing-item-row'
        const saved = $all('#orderItemsBody tr.existing-item-row');
        return saved.length > 0;
      }

      function initState() {
        // Default: Save disabled until a change is made
        setSaveEnabled(false);
        // Payment enabled only when there are saved items and requirements are met
        setPaymentEnabled(hasSavedItems());
        applyPaymentRequirementsUI();
        // Fire to kitchen enabled only when there are saved items
        setFireEnabled(hasSavedItems());
        updateSaveStateUI();
        // If the order is fully paid and completed, enforce disabled UI state
        if (isFullyPaid) {
          // Disable payment and fire permanently on this view
          setPaymentEnabled(false);
          setFireEnabled(false);
          // Disable add input and button
          const menuInput = document.getElementById('menuItemInput');
          const addBtn = document.getElementById('addItemBtn');
          if (menuInput) menuInput.disabled = true;
          if (addBtn) addBtn.disabled = true;
          // Hide edit/remove controls
          document.querySelectorAll('.edit-row, .remove-existing, .save-row, .cancel-row').forEach(el => el.classList.add('d-none'));
        }
      }

      // When new rows are added or removed, enable Save (new items) or update Payment state
      if (itemsBody) {
        const mo = new MutationObserver(mutations => {
          // Some DOM changes (e.g., server-synced cancel) should not mark the page dirty.
          const skipDirty = orderApp && orderApp.dataset && orderApp.dataset.skipDirty === 'true';
          for (const m of mutations) {
            if (m.addedNodes && m.addedNodes.length) {
              // new item(s) added -> enable Save
              if (skipDirty) { continue; }
              isDirty = true;
              setSaveEnabled(true);
              updateSaveStateUI();
            }
            if (m.removedNodes && m.removedNodes.length) {
              // an item removed -> consider enabling Save
              if (skipDirty) { continue; }
              isDirty = true;
              setSaveEnabled(true);
              updateSaveStateUI();
            }
          }
          if (skipDirty && orderApp && orderApp.dataset) {
            orderApp.dataset.skipDirty = 'false';
          }
        });
        mo.observe(itemsBody, { childList: true });
      }

      // Listen for user interactions that modify rows: edits, quantity/note changes, remove
      document.addEventListener('input', function(e) {
        if (e.target && e.target.closest('#orderItemsTable')) {
          isDirty = true;
          setSaveEnabled(true);
          updateSaveStateUI();
        }
      }, { passive: true });

      document.addEventListener('click', function(e) {
        if (e.target.closest && e.target.closest('#orderItemAddForm')) {
          // adding via form will be handled by mutation observer after row insertion
          return;
        }
        if (e.target.closest && e.target.closest('.edit-row')) {
          // entering edit mode -> enable Save
          isDirty = true;
          setSaveEnabled(true);
          updateSaveStateUI();
        }
        if (e.target && e.target.id === 'saveOrderBtn') {
          // optimistic: disable Save while saving; actual outcome will be handled by fetch proxy below
          setSaveEnabled(false);
          isDirty = false;
          updateSaveStateUI();
        }
      }, true);

      // Intercept fetch so we can enable Payment when the order items save endpoint succeeds
      (function() {
        if (!window.fetch) return;
        const originalFetch = window.fetch.bind(window);
        window.fetch = async function(input, init) {
          try {
            const url = (typeof input === 'string') ? input : (input && input.url) ? input.url : '';
            const response = await originalFetch(input, init);
            // If this was the order items save endpoint and succeeded, enable Payment
            if (typeof url === 'string' && url.indexOf('/Order/UpdateMultipleOrderItems') !== -1) {
              if (response && response.ok) {
                // Saved to DB -> payment now allowed
                setPaymentEnabled(true);
                applyPaymentRequirementsUI();
                // Also enable Fire to Kitchen when items are saved
                setFireEnabled(hasSavedItems());
              } else {
                // error -> re-enable Save so user can retry
                isDirty = true;
                setSaveEnabled(true);
                updateSaveStateUI();
              }
            }
            return response;
          } catch (err) {
            console.error('Fetch proxy error', err);
            throw err;
          }
        };
      })();

      // Initialize
      try { initState(); } catch (e) { console.error(e); }

      // --- Dynamic Menu Item autosuggest filtering by group ---
      const groupSelect = document.getElementById('menuItemGroupSelect');
      const dataList = document.getElementById('menuItems');
      const menuInput = document.getElementById('menuItemInput');

      async function loadMenuItemsForGroup(groupId) {
        if (!dataList) return;
        try {
          const orderIdElem = document.getElementById('orderDetailsApp');
          const orderId = orderIdElem ? orderIdElem.getAttribute('data-order-id') : '';
          const resp = await fetch(`/Order/GetMenuItemsByGroup?groupId=${encodeURIComponent(groupId)}&orderId=${encodeURIComponent(orderId)}`);
          if (!resp.ok) return;
          const items = await resp.json();
          // Clear datalist
          dataList.innerHTML = '';
          for (const it of items) {
            const opt = document.createElement('option');
            opt.value = it.name || it.Name;
            const plu = (it.PLUCode || it.pluCode || '');
            const price = (it.Price ?? it.price ?? 0).toFixed ? (it.Price ?? it.price).toFixed(2) : (Number(it.Price ?? it.price) || 0).toFixed(2);
            opt.setAttribute('data-id', it.Id ?? it.id);
            opt.setAttribute('data-price', price);
            opt.setAttribute('data-plu', plu);
            opt.textContent = `${plu} - ${it.Name ?? it.name} (₹${price})`;
            dataList.appendChild(opt);
          }
          // Clear the current input so user sees filtered list
          if (menuInput) menuInput.value = '';
        } catch (err) {
          console.error('Failed to load menu items by group', err);
        }
      }

      if (groupSelect) {
        groupSelect.addEventListener('change', (e) => {
          const gid = e.target.value || '1';
          loadMenuItemsForGroup(gid);
        });
        // Don't load on initial page load - server-side rendering already provides correct prices
        // Only reload when user changes the group selection
      }
    })();
  </script>
}
