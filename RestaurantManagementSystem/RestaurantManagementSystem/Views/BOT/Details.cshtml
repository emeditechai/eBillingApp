@model RestaurantManagementSystem.Models.BeverageOrderTicket
@{
    ViewData["Title"] = "BOT Details - " + Model.BOT_No;
    
    string badgeClass = Model.Status switch
    {
        0 => "bg-info",
        1 => "bg-warning",
        2 => "bg-success",
        3 => "bg-secondary",
        4 => "bg-danger",
        _ => "bg-secondary"
    };
}

<div class="container-fluid mt-4">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h2><i class="fas fa-cocktail"></i> BOT Details - @Model.BOT_No</h2>
        <div>
            <a href="@Url.Action("Dashboard")" class="btn btn-secondary">
                <i class="fas fa-arrow-left"></i> Back
            </a>
            <a href="@Url.Action("Print", new { id = Model.BOT_ID })" class="btn btn-primary" target="_blank">
                <i class="fas fa-print"></i> Print
            </a>
        </div>
    </div>

    @if (TempData["SuccessMessage"] != null)
    {
        <div class="alert alert-success alert-dismissible fade show" role="alert">
            @TempData["SuccessMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    @if (TempData["ErrorMessage"] != null)
    {
        <div class="alert alert-danger alert-dismissible fade show" role="alert">
            @TempData["ErrorMessage"]
            <button type="button" class="btn-close" data-bs-dismiss="alert"></button>
        </div>
    }

    <div class="row">
        <!-- BOT Header Information -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-primary text-white">
                    <h5 class="mb-0"><i class="fas fa-info-circle"></i> BOT Information</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th>BOT Number:</th>
                            <td><strong>@Model.BOT_No</strong></td>
                        </tr>
                        <tr>
                            <th>Status:</th>
                            <td><span class="badge @badgeClass">@Model.StatusDisplay</span></td>
                        </tr>
                        <tr>
                            <th>Order Number:</th>
                            <td>@Model.OrderNumber</td>
                        </tr>
                        <tr>
                            <th>Table:</th>
                            <td>@(Model.TableName ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th>Guest Name:</th>
                            <td>@(Model.GuestName ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th>Cashier:</th>
                            <td>@(Model.ServerName ?? "N/A")</td>
                        </tr>
                        <tr>
                            <th>Created At:</th>
                            <td>@Model.CreatedAt.ToString("dd MMM yyyy HH:mm")</td>
                        </tr>
                        <tr>
                            <th>Created By:</th>
                            <td>@(Model.CreatedBy ?? "System")</td>
                        </tr>
                        @if (Model.ServedAt.HasValue)
                        {
                            <tr>
                                <th>Served At:</th>
                                <td>@Model.ServedAt.Value.ToString("dd MMM yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.BilledAt.HasValue)
                        {
                            <tr>
                                <th>Billed At:</th>
                                <td>@Model.BilledAt.Value.ToString("dd MMM yyyy HH:mm")</td>
                            </tr>
                        }
                        @if (Model.VoidedAt.HasValue)
                        {
                            <tr>
                                <th>Voided At:</th>
                                <td>@Model.VoidedAt.Value.ToString("dd MMM yyyy HH:mm")</td>
                            </tr>
                            <tr>
                                <th>Void Reason:</th>
                                <td>@Model.VoidReason</td>
                            </tr>
                        }
                    </table>
                </div>
            </div>
        </div>

        <!-- BOT Amounts -->
        <div class="col-md-6 mb-4">
            <div class="card">
                <div class="card-header bg-success text-white">
                    <h5 class="mb-0"><i class="fas fa-rupee-sign"></i> Amount Details</h5>
                </div>
                <div class="card-body">
                    <table class="table table-borderless">
                        <tr>
                            <th>Subtotal:</th>
                            <td class="text-end"><strong>₹@Model.SubtotalAmount.ToString("N2")</strong></td>
                        </tr>
                        <tr>
                            <th>Tax Amount:</th>
                            <td class="text-end">₹@Model.TaxAmount.ToString("N2")</td>
                        </tr>
                        <tr class="table-active">
                            <th><strong>Total Amount:</strong></th>
                            <td class="text-end"><strong>₹@Model.TotalAmount.ToString("N2")</strong></td>
                        </tr>
                    </table>

                    @if (Model.Status < 3)
                    {
                        <hr/>
                        <h6>Status Actions</h6>
                        <form method="post" action="@Url.Action("UpdateStatus")" class="d-inline">
                            @Html.AntiForgeryToken()
                            <input type="hidden" name="botId" value="@Model.BOT_ID" />
                            @if (Model.Status == 0)
                            {
                                <button type="submit" name="newStatus" value="1" class="btn btn-warning w-100 mb-2">
                                    <i class="fas fa-play"></i> Start Preparation
                                </button>
                            }
                            @if (Model.Status == 1)
                            {
                                <button type="submit" name="newStatus" value="2" class="btn btn-success w-100 mb-2">
                                    <i class="fas fa-check"></i> Mark as Ready
                                </button>
                            }
                            @if (Model.Status == 2)
                            {
                                <button type="submit" name="newStatus" value="3" class="btn btn-secondary w-100 mb-2">
                                    <i class="fas fa-file-invoice-dollar"></i> Mark as Billed
                                </button>
                            }
                        </form>

                        @if (Model.Status != 4)
                        {
                            <button type="button" class="btn btn-danger w-100" data-bs-toggle="modal" data-bs-target="#voidModal">
                                <i class="fas fa-times"></i> Void BOT
                            </button>
                        }
                    }
                </div>
            </div>
        </div>
    </div>

    <!-- BOT Items -->
    <div class="card">
        <div class="card-header bg-info text-white">
            <h5 class="mb-0"><i class="fas fa-list"></i> Beverage Items (@Model.Items.Count)</h5>
        </div>
        <div class="card-body">
            <table class="table table-hover">
                <thead class="table-dark">
                    <tr>
                        <th>#</th>
                        <th>Item Name</th>
                        <th>Qty</th>
                        <th>Price</th>
                        <th>Amount</th>
                        <th>Tax</th>
                        <th>Type</th>
                        <th>Status</th>
                        <th>Instructions</th>
                    </tr>
                </thead>
                <tbody>
                    @if (Model.Items != null && Model.Items.Any())
                    {
                        int index = 1;
                        foreach (var item in Model.Items)
                        {
                            string itemBadge = item.Status switch
                            {
                                0 => "bg-info",
                                1 => "bg-warning",
                                2 => "bg-success",
                                3 => "bg-secondary",
                                _ => "bg-secondary"
                            };

                            <tr>
                                <td>@index</td>
                                <td>
                                    <strong>@item.MenuItemName</strong>
                                    @if (item.IsAlcoholic)
                                    {
                                        <span class="badge bg-danger ms-2">Alcoholic</span>
                                    }
                                </td>
                                <td>@item.Quantity</td>
                                <td>₹@item.UnitPrice.ToString("N2")</td>
                                <td>₹@item.Amount.ToString("N2")</td>
                                <td>₹@item.TaxAmount.ToString("N2") (@item.TaxRate%)</td>
                                <td>
                                    @if (item.IsAlcoholic)
                                    {
                                        <span class="text-danger">Excise/VAT</span>
                                    }
                                    else
                                    {
                                        <span class="text-success">GST</span>
                                    }
                                </td>
                                <td><span class="badge @itemBadge">@item.StatusDisplay</span></td>
                                <td>@(item.SpecialInstructions ?? "-")</td>
                            </tr>
                            index++;
                        }
                    }
                    else
                    {
                        <tr>
                            <td colspan="9" class="text-center text-muted">No items found</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>
</div>

<!-- Void Modal -->
<div class="modal fade" id="voidModal" tabindex="-1">
    <div class="modal-dialog">
        <div class="modal-content">
            <form method="post" action="@Url.Action("Void")">
                @Html.AntiForgeryToken()
                <input type="hidden" name="botId" value="@Model.BOT_ID" />
                <div class="modal-header bg-danger text-white">
                    <h5 class="modal-title">Void BOT</h5>
                    <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal"></button>
                </div>
                <div class="modal-body">
                    <div class="alert alert-warning">
                        <i class="fas fa-exclamation-triangle"></i> 
                        Are you sure you want to void BOT <strong>@Model.BOT_No</strong>?
                    </div>
                    <div class="mb-3">
                        <label for="reason" class="form-label">Reason for Void <span class="text-danger">*</span></label>
                        <textarea class="form-control" id="reason" name="reason" rows="3" required></textarea>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Cancel</button>
                    <button type="submit" class="btn btn-danger">Void BOT</button>
                </div>
            </form>
        </div>
    </div>
</div>
