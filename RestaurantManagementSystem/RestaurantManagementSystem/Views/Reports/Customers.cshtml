@model RestaurantManagementSystem.Models.CustomerReportViewModel

@{
    ViewData["Title"] = "Customer Reports";
}

<div class="container-fluid">
    <div class="row mb-3">
        <div class="col-12">
            <div class="d-flex justify-content-between align-items-center report-header cust-pro-header rounded-3 shadow-sm px-3 py-2">
                <div class="d-flex align-items-center gap-3">
                    <div class="cust-header-icon d-flex align-items-center justify-content-center rounded-2"><i class="fas fa-users fa-lg"></i></div>
                    <div>
                        <h1 class="cust-header-title mb-1">Customers</h1>
                        <p class="cust-header-subtitle mb-0">Insights on visits, revenue, loyalty, and demographics</p>
                    </div>
                </div>
                <nav aria-label="breadcrumb" class="ms-3">
                    <ol class="breadcrumb mb-0">
                        <li class="breadcrumb-item"><a asp-controller="Home" asp-action="Index">Home</a></li>
                        <li class="breadcrumb-item"><a asp-controller="Reports" asp-action="Index">Reports</a></li>
                        <li class="breadcrumb-item active">Customers</li>
                    </ol>
                </nav>
            </div>
        </div>
    </div>

    <form method="post" asp-action="Customers" class="row g-3 align-items-end mb-4">
        <div class="col-auto">
            <label asp-for="Filter.From" class="form-label">From</label>
            <input asp-for="Filter.From" class="form-control" type="date" />
        </div>
        <div class="col-auto">
            <label asp-for="Filter.To" class="form-label">To</label>
            <input asp-for="Filter.To" class="form-control" type="date" />
        </div>
        <div class="col d-flex justify-content-end gap-2">
            <button type="submit" class="btn btn-success"><i class="fas fa-sync-alt me-1"></i>Refresh</button>
            <button type="button" id="exportCustomersCsvBtn" class="btn btn-outline-secondary"><i class="fas fa-file-csv me-1"></i>CSV</button>
            <button type="button" id="printCustomersBtn" class="btn btn-outline-primary"><i class="fas fa-print me-1"></i>Print</button>
        </div>
    </form>

    <style>
        /* Professional page heading */
        .report-header { border-bottom: 1px solid #e9ecef; }
        .cust-pro-header { background: linear-gradient(90deg,#ffffff 0%, #f8fafc 60%, #eef2f7 100%); }
        .cust-header-icon { width:56px; height:56px; background:linear-gradient(135deg,#0ea5e9,#2563eb); color:#fff; box-shadow:0 4px 12px rgba(37,99,235,.3); }
        .cust-header-title { font-size:2.0rem; font-weight:800; color:#212529; letter-spacing:-.3px; }
        .cust-header-subtitle { font-size:.95rem; color:#5a6572; font-weight:500; }
        @@media (max-width:768px){ .cust-header-title{ font-size:1.55rem;} .cust-header-icon{ width:44px; height:44px;}}

        .report-tile { border-radius: 8px; color: #fff; min-height: 150px; display:block; }
        .report-tile .tile-content { height:100%; }
        .report-tile h2 { font-weight:700; }
        .tile-blue { background: linear-gradient(135deg,#4f93ff 0%,#2b6de9 100%); }
        .tile-green { background: linear-gradient(135deg,#2ad399 0%,#0fb07a 100%); }
        .tile-purple { background: linear-gradient(135deg,#9b7bff 0%,#6a4bff 100%); }
        /* table highlight */
        .table.table-sm tbody tr:hover { background-color: rgba(0,0,0,0.03); }
        .table-sticky thead th { position: sticky; top: 0; background: #f8f9fa; z-index: 1; }
        .kpi-sub { opacity: .9; }
    @@media (max-width: 767px) { .report-tile { min-height:120px; } }
    </style>

    <div class="row">
        <div class="col-md-4">
            <div class="report-tile tile-blue mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Customers</h6>
                            <h2 class="mb-0">@Model.Summary.TotalCustomers</h2>
                            <small class="text-light">New: @Model.Summary.NewCustomers &middot; Returning: @Model.Summary.ReturningCustomers</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="customersSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="report-tile tile-purple mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Avg Visits</h6>
                            <h2 class="mb-0">@Model.Summary.AverageVisitsPerCustomer</h2>
                            <small class="text-light">Visits per customer (avg)</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="visitsSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-md-4">
            <div class="report-tile tile-green mb-3">
                <div class="tile-content d-flex flex-column justify-content-center align-items-start p-3">
                    <div class="d-flex w-100 justify-content-between align-items-start">
                        <div>
                            <h6 class="text-uppercase text-muted mb-1">Total Revenue</h6>
                            <h2 class="mb-0">@Model.Summary.TotalRevenue.ToString("C")</h2>
                            <small class="text-light">Revenue across selected period</small>
                        </div>
                        <div style="width:90px; height:48px;"><canvas id="revenueSparkline"></canvas></div>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header d-flex justify-content-between align-items-center">
                    <span>Top Customers</span>
                    <span class="small text-muted">Period: @Model.Filter.From?.ToString("dd MMM yyyy") â€“ @Model.Filter.To?.ToString("dd MMM yyyy")</span>
                </div>
                <div class="card-body">
                    <div class="table-responsive">
                    <table class="table table-sm table-hover align-middle table-sticky" id="topCustomersTable">
                        <thead>
                            <tr>
                                <th>Name</th>
                                <th>Phone</th>
                                <th class="text-end">Visits</th>
                                <th class="text-end">Revenue</th>
                                <th class="text-end">LTV</th>
                            </tr>
                        </thead>
                        <tbody>
                            @foreach (var c in Model.TopCustomers)
                            {
                                <tr>
                                    <td>@c.Name</td>
                                    <td>@c.Phone</td>
                                    <td class="text-end"><span class="badge bg-secondary">@c.Visits</span></td>
                                    <td class="text-end">@c.Revenue.ToString("C")</td>
                                    <td class="text-end fw-semibold">@c.LTV.ToString("C")</td>
                                </tr>
                            }
                        </tbody>
                    </table>
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Visit Frequency</div>
                <div class="card-body">
                    <canvas id="visitFrequencyChart"></canvas>
                </div>
            </div>
        </div>
    </div>

    <div class="row mt-3">
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Loyalty Buckets</div>
                <div class="card-body">
                    @{ var loyaltyTotal = Model.LoyaltyStats?.Sum(x => x.CustomerCount) ?? 0; }
                    <div class="vstack gap-2">
                        @foreach (var b in Model.LoyaltyStats)
                        {
                            var pct = loyaltyTotal > 0 ? (int)Math.Round(b.CustomerCount * 100.0 / loyaltyTotal) : 0;
                            <div>
                                <div class="d-flex justify-content-between"><span>@b.Bucket</span><span class="text-muted">@b.CustomerCount (@pct%)</span></div>
                                <div class="progress" style="height:8px;">
                                    <div class="progress-bar bg-info" role="progressbar" style="width:@pct%" aria-valuenow="@pct" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
        <div class="col-lg-6">
            <div class="card mb-3">
                <div class="card-header">Demographics</div>
                <div class="card-body">
                    @{ var demoTotal = Model.Demographics?.Sum(d => d.Count) ?? 0; }
                    <div class="vstack gap-2">
                        @foreach (var d in Model.Demographics)
                        {
                            var pct = demoTotal > 0 ? (int)Math.Round(d.Count * 100.0 / demoTotal) : 0;
                            <div>
                                <div class="d-flex justify-content-between"><span>@d.Category</span><span class="text-muted">@d.Count (@pct%)</span></div>
                                <div class="progress" style="height:8px;">
                                    <div class="progress-bar bg-secondary" role="progressbar" style="width:@pct%" aria-valuenow="@pct" aria-valuemin="0" aria-valuemax="100"></div>
                                </div>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

@section Scripts {
    <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
    <script>
        (function(){
            var visits = @Html.Raw(System.Text.Json.JsonSerializer.Serialize(Model.VisitFrequencies.Select(x=> new { x.Period, x.Visits, x.Revenue })));

            // main visit frequency chart
            var ctx = document.getElementById('visitFrequencyChart');
            if (ctx) {
                var vctx = ctx.getContext('2d');
                var labels = visits.map(v=>v.Period);
                var data = visits.map(v=>v.Visits);
                new Chart(vctx, {
                    type: 'line',
                    data: { labels: labels, datasets: [{ label: 'Visits', data: data, borderColor: '#007bff', backgroundColor: 'rgba(0,123,255,0.08)', fill:true }] },
                    options: { responsive:true, plugins:{legend:{display:false}}, scales:{y:{beginAtZero:true}} }
                });
            }

            // small sparklines for tiles (customers, visits, revenue)
            function createSparkline(canvasId, dataPoints, color) {
                var el = document.getElementById(canvasId);
                if (!el) return;
                new Chart(el.getContext('2d'), {
                    type: 'line',
                    data: { labels: dataPoints.map((_,i)=>i), datasets: [{ data: dataPoints, borderColor: color, backgroundColor: color, fill:false, tension:0.3 }] },
                    options: { responsive:true, maintainAspectRatio:false, plugins:{legend:{display:false}}, elements:{point:{radius:0}}, scales:{x:{display:false}, y:{display:false}} }
                });
            }

            var visitVals = visits.map(v=>v.Visits);
            var revenueVals = visits.map(v=>parseFloat(v.Revenue || 0));
            // customers sparkline: if VisitFrequencies not containing distinct customers, use visits as proxy
            createSparkline('customersSparkline', visitVals, '#ffffff');
            createSparkline('visitsSparkline', visitVals, '#ffffff');
            createSparkline('revenueSparkline', revenueVals, '#ffffff');

            // Export Top Customers to CSV
            const csvBtn = document.getElementById('exportCustomersCsvBtn');
            if (csvBtn) {
                csvBtn.addEventListener('click', function(){
                    const rows = Array.from(document.querySelectorAll('#topCustomersTable tr'));
                    const csv = rows.map(r => Array.from(r.children).map(c => '"' + c.innerText.replace(/"/g,'""') + '"').join(',')).join('\n');
                    const blob = new Blob([csv], { type: 'text/csv;charset=utf-8;' });
                    const url = URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url; a.download = 'top_customers.csv'; a.click(); URL.revokeObjectURL(url);
                });
            }

            // Print section
            const printBtn = document.getElementById('printCustomersBtn');
            if (printBtn) {
                printBtn.addEventListener('click', function(){
                    const content = document.querySelector('.container-fluid').outerHTML;
                    const w = window.open('', '_blank');
                    w.document.write('<html><head><title>Customers Report</title><link rel="stylesheet" href="/lib/bootstrap/dist/css/bootstrap.min.css" /></head><body>');
                    w.document.write(content);
                    w.document.write('</body></html>');
                    w.print(); w.close();
                });
            }
        })();
    </script>
}