@model RestaurantManagementSystem.Models.Reservation
@{
    ViewData["Title"] = Model.Id == 0 ? "Create Reservation" : "Edit Reservation";
    bool isReadOnly = ViewBag.ReadOnly != null && (bool)ViewBag.ReadOnly;
}

<div class="container-fluid py-2">
    <h4 class="mb-3">@ViewData["Title"]</h4>

    <div class="card shadow-sm">
        <div class="card-body p-3">
            <form asp-action="SaveReservation" method="post" id="reservationForm">
                <input type="hidden" asp-for="Id" />
                <input type="hidden" asp-for="CreatedAt" />
                <input type="hidden" asp-for="ReminderSent" />
                <input type="hidden" asp-for="NoShow" />

                <!-- Main information - 3 columns layout for compactness -->
                <div class="row g-2">
                    <!-- Column 1 -->
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label asp-for="GuestName" class="form-label small mb-1">Guest Name</label>
                            <input asp-for="GuestName" class="form-control form-control-sm" required />
                            <span asp-validation-for="GuestName" class="text-danger small"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="PhoneNumber" class="form-label small mb-1">Phone Number</label>
                            <input asp-for="PhoneNumber" class="form-control form-control-sm" required />
                            <span asp-validation-for="PhoneNumber" class="text-danger small"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="EmailAddress" class="form-label small mb-1">Email Address</label>
                            <input asp-for="EmailAddress" class="form-control form-control-sm" />
                            <span asp-validation-for="EmailAddress" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Column 2 -->
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label asp-for="ReservationDate" class="form-label small mb-1">Date</label>
                            <input asp-for="ReservationDate" class="form-control form-control-sm" type="date" required />
                            <span asp-validation-for="ReservationDate" class="text-danger small"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="ReservationTime" class="form-label small mb-1">Time</label>
                            <input asp-for="ReservationTime" class="form-control form-control-sm" type="time" required />
                            <span asp-validation-for="ReservationTime" class="text-danger small"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="PartySize" class="form-label small mb-1">Party Size</label>
                            <input asp-for="PartySize" class="form-control form-control-sm" type="number" min="1" max="50" required />
                            <span asp-validation-for="PartySize" class="text-danger small"></span>
                        </div>
                    </div>

                    <!-- Column 3 -->
                    <div class="col-md-4">
                        <div class="mb-2">
                            <label asp-for="TableId" class="form-label small mb-1">
                                Table 
                                <span class="badge bg-info text-white ms-1" style="font-size: 0.65rem;">Smart Recommendations</span>
                            </label>
                            <select asp-for="TableId" class="form-select form-select-sm" id="tableSelect">
                                <option value="">-- Select a Table --</option>
                                @{
                                    int rank = 1;
                                    foreach (var table in ViewBag.Tables)
                                    {
                                        string badgeIcon = "";
                                        string badgeClass = "";
                                        string recommendText = "";
                                        
                                        // Top 3 recommendations get special badges
                                        if (rank == 1)
                                        {
                                            badgeIcon = "‚≠ê";
                                            recommendText = " (Best Match)";
                                            badgeClass = "bg-success";
                                        }
                                        else if (rank == 2)
                                        {
                                            badgeIcon = "ü•à";
                                            recommendText = " (Great Choice)";
                                            badgeClass = "bg-primary";
                                        }
                                        else if (rank == 3)
                                        {
                                            badgeIcon = "ü•â";
                                            recommendText = " (Good Option)";
                                            badgeClass = "bg-info";
                                        }
                                        
                                        // Calculate capacity match
                                        int capacityDiff = table.Capacity - Model.PartySize;
                                        string capacityNote = capacityDiff == 0 ? " - Perfect fit!" : 
                                                            capacityDiff == 1 ? " - Excellent match" :
                                                            capacityDiff == 2 ? " - Good match" :
                                                            capacityDiff > 6 ? " - Large table" : "";
                                        
                                        // Section info
                                        string sectionInfo = !string.IsNullOrEmpty(table.Section) ? $" [{table.Section}]" : "";
                                        
                                        <option value="@table.Id" data-rank="@rank" data-capacity="@table.Capacity" data-section="@table.Section">
                                            @badgeIcon Table @table.TableNumber (Seats @table.Capacity)@sectionInfo@recommendText@capacityNote
                                        </option>
                                        
                                        rank++;
                                    }
                                }
                            </select>
                            <small class="text-muted d-block mt-1">
                                <i class="bi bi-lightbulb"></i> Top recommendations based on party size, time, and location
                            </small>
                            <span asp-validation-for="TableId" class="text-danger small"></span>
                        </div>

                        <div class="mb-2">
                            <label asp-for="Status" class="form-label small mb-1">Status</label>
                            <select asp-for="Status" class="form-select form-select-sm" asp-items="Html.GetEnumSelectList<ReservationStatus>()"></select>
                            <span asp-validation-for="Status" class="text-danger small"></span>
                        </div>
                    </div>
                </div>

                <!-- Special requests and notes in a single row -->
                <div class="row g-2 mt-1">
                    <div class="col-md-6">
                        <div class="mb-2">
                            <label asp-for="SpecialRequests" class="form-label small mb-1">Special Requests</label>
                            <textarea asp-for="SpecialRequests" class="form-control form-control-sm" rows="2"></textarea>
                            <span asp-validation-for="SpecialRequests" class="text-danger small"></span>
                        </div>
                    </div>

                    <div class="col-md-6">
                        <div class="mb-2">
                            <label asp-for="Notes" class="form-label small mb-1">Internal Notes</label>
                            <textarea asp-for="Notes" class="form-control form-control-sm" rows="2"></textarea>
                            <span asp-validation-for="Notes" class="text-danger small"></span>
                        </div>
                    </div>
                </div>

                <!-- Action buttons - fixed at the bottom -->
                <div class="d-flex justify-content-between mt-3">
                    <a asp-action="List" asp-route-date="@Model.ReservationDate.ToString("yyyy-MM-dd")" class="btn btn-sm btn-outline-secondary">
                        <i class="bi bi-arrow-left"></i> Back to List
                    </a>
                    <button type="submit" class="btn btn-sm btn-primary px-4" style="@(isReadOnly ? "display:none;" : "")">
                        <i class="bi bi-save"></i> Save Reservation
                    </button>
                </div>
            </form>
        </div>
    </div>
</div>

@section Scripts {
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.10.0/font/bootstrap-icons.css" />
    @{await Html.RenderPartialAsync("_ValidationScriptsPartial");}
    <style>
        /* Smart recommendation styling */
        #tableSelect option[data-rank="1"] {
            background-color: #d4edda;
            font-weight: bold;
        }
        #tableSelect option[data-rank="2"] {
            background-color: #d1ecf1;
            font-weight: 600;
        }
        #tableSelect option[data-rank="3"] {
            background-color: #fff3cd;
        }
        
        /* Highlight selected recommendation */
        #tableSelect:focus option[data-rank="1"],
        #tableSelect:focus option[data-rank="2"],
        #tableSelect:focus option[data-rank="3"] {
            font-weight: bold;
        }
        
        /* Recommendation info box */
        .recommendation-info {
            display: none;
            margin-top: 0.5rem;
            padding: 0.5rem;
            border-radius: 0.375rem;
            font-size: 0.875rem;
        }
        
        .recommendation-info.show {
            display: block;
        }
        
        .recommendation-info.rank-1 {
            background-color: #d4edda;
            border-left: 4px solid #28a745;
        }
        
        .recommendation-info.rank-2 {
            background-color: #d1ecf1;
            border-left: 4px solid #17a2b8;
        }
        
        .recommendation-info.rank-3 {
            background-color: #fff3cd;
            border-left: 4px solid #ffc107;
        }
    </style>
    <script>
        $(document).ready(function() {
            var isReadOnly = @((isReadOnly).ToString().ToLowerInvariant());
            if (isReadOnly) {
                document.querySelectorAll('#reservationForm input, #reservationForm select, #reservationForm textarea').forEach(function (el) {
                    if (el.type === 'hidden') return;
                    el.disabled = true;
                });
            }

            // Add recommendation info box after table select
            var infoBox = $('<div class="recommendation-info" id="tableRecommendationInfo"></div>');
            $('#tableSelect').after(infoBox);
            
            // Show recommendation info when table is selected
            $('#tableSelect').change(function() {
                var selectedOption = $(this).find('option:selected');
                var rank = selectedOption.data('rank');
                var capacity = selectedOption.data('capacity');
                var section = selectedOption.data('section');
                var partySize = $('#PartySize').val();
                
                if (rank && rank <= 3) {
                    var messages = {
                        1: {
                            icon: '‚≠ê',
                            title: 'Best Match',
                            class: 'rank-1',
                            description: 'This table is highly recommended based on your party size, reservation time, and optimal seating efficiency.'
                        },
                        2: {
                            icon: 'ü•à',
                            title: 'Great Choice',
                            class: 'rank-2',
                            description: 'Excellent alternative that provides good capacity match and location.'
                        },
                        3: {
                            icon: 'ü•â',
                            title: 'Good Option',
                            class: 'rank-3',
                            description: 'Suitable choice with good availability and reasonable capacity.'
                        }
                    };
                    
                    var msg = messages[rank];
                    var capacityDiff = capacity - partySize;
                    var capacityText = capacityDiff == 0 ? 'Perfect capacity match!' :
                                      capacityDiff == 1 ? 'Nearly perfect fit' :
                                      capacityDiff == 2 ? 'Good capacity fit' :
                                      capacityDiff > 6 ? 'Note: This is a larger table' :
                                      'Suitable capacity';
                    
                    var sectionText = section ? ' | Section: ' + section : '';
                    
                    infoBox.html(
                        '<strong>' + msg.icon + ' ' + msg.title + '</strong><br>' +
                        msg.description + '<br>' +
                        '<small class="text-muted">' + capacityText + sectionText + '</small>'
                    );
                    infoBox.removeClass('rank-1 rank-2 rank-3').addClass(msg.class + ' show');
                } else {
                    infoBox.removeClass('show');
                }
            });
            
            // Auto-select best recommendation if none selected
            if (!$('#TableId').val() && $('#tableSelect option[data-rank="1"]').length > 0) {
                // Highlight but don't auto-select to give user control
                $('#tableSelect').addClass('border-success');
                setTimeout(function() {
                    $('#tableSelect').removeClass('border-success');
                }, 3000);
            }
            
            // Update available tables when date, time or party size changes
            $('#ReservationDate, #ReservationTime, #PartySize').change(function() {
                if (!isReadOnly) {
                    updateAvailableTables();
                }
            });

            function updateAvailableTables() {
                var date = $('#ReservationDate').val();
                var time = $('#ReservationTime').val();
                var partySize = $('#PartySize').val();

                if (isReadOnly) {
                    return;
                }
                
                if (date && time && partySize) {
                    // Show loading state
                    $('#tableSelect').prop('disabled', true);
                    $('#tableSelect').html('<option value="">Loading recommendations...</option>');
                    
                    // Ajax call to get recommended tables
                    $.ajax({
                        url: '@Url.Action("GetAvailableTablesJson", "Reservation")',
                        method: 'GET',
                        data: {
                            reservationDate: date,
                            reservationTime: time,
                            partySize: partySize,
                            currentTableId: $('#TableId').val()
                        },
                        success: function(tables) {
                            $('#tableSelect').prop('disabled', false);
                            $('#tableSelect').html('<option value="">-- Select a Table --</option>');
                            
                            var rank = 1;
                            $.each(tables, function(index, table) {
                                var badge = rank == 1 ? '‚≠ê' : rank == 2 ? 'ü•à' : rank == 3 ? 'ü•â' : '';
                                var recommendText = rank == 1 ? ' (Best Match)' : 
                                                   rank == 2 ? ' (Great Choice)' : 
                                                   rank == 3 ? ' (Good Option)' : '';
                                var capacityDiff = table.Capacity - partySize;
                                var capacityNote = capacityDiff == 0 ? ' - Perfect fit!' : 
                                                  capacityDiff == 1 ? ' - Excellent' :
                                                  capacityDiff == 2 ? ' - Good match' : '';
                                var tableId = (table.id !== undefined && table.id !== null) ? table.id : table.Id;
                                var tableNumber = (table.tableNumber !== undefined && table.tableNumber !== null) ? table.tableNumber : table.TableNumber;
                                var capacity = (table.capacity !== undefined && table.capacity !== null) ? table.capacity : table.Capacity;
                                var section = (table.section !== undefined && table.section !== null) ? table.section : table.Section;
                                var sectionInfo = section ? ' [' + section + ']' : '';
                                
                                $('#tableSelect').append(
                                    $('<option></option>')
                                        .val(tableId)
                                        .attr('data-rank', rank)
                                        .attr('data-capacity', capacity)
                                        .attr('data-section', section || '')
                                        .text(badge + ' Table ' + tableNumber + ' (Seats ' + capacity + ')' + sectionInfo + recommendText + capacityNote)
                                );
                                rank++;
                            });
                            
                            if (tables.length == 0) {
                                $('#tableSelect').html('<option value="">No tables available for this time</option>');
                            }
                        },
                        error: function() {
                            $('#tableSelect').prop('disabled', false);
                            $('#tableSelect').html('<option value="">Error loading tables</option>');
                        }
                    });
                }
            }
            
            // Trigger initial check if editing existing reservation
            if ($('#ReservationDate').val() && $('#ReservationTime').val() && $('#PartySize').val()) {
                // Don't reload on edit, keep existing selection
            }
        });
    </script>
}
