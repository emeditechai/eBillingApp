@model PaymentViewModel
@{
    ViewData["Title"] = "Print Bill";
    Layout = "_PrintLayout";
    var billPageFormat = (ViewBag.BillPageFormat ?? "A4").ToString();
    var isA5Format = string.Equals(billPageFormat, "A5", StringComparison.OrdinalIgnoreCase);
}

<!-- CSS moved to bill-style.css -->

@if (isA5Format)
{
    <style>
        @@media screen {
            .container.p-3 {
                width: 210mm;
                min-height: 148mm;
                margin: 10px auto;
                background: #fff;
                box-shadow: 0 0 0 1px #ddd;
                padding: 6mm !important;
            }
        }

        @@media print {
            @@page {
                size: 210mm 148mm;
                margin: 3mm;
            }

            html,
            body {
                width: 210mm;
                height: 148mm;
            }

            body {
                font-size: 8.5pt;
                line-height: 1.12;
                -webkit-print-color-adjust: exact;
                print-color-adjust: exact;
            }

            .container.p-3 {
                width: 100% !important;
                max-width: none !important;
                margin: 0 !important;
                padding: 0 !important;
            }

            .bill-header {
                margin-bottom: 4px;
                padding-bottom: 3px;
            }

            .bill-header h2 {
                font-size: 13pt;
                margin-bottom: 1px;
            }

            .bill-header p {
                font-size: 7.6pt;
                line-height: 1.05;
                margin-bottom: 1px;
            }

            .bill-title {
                margin-top: 3px;
                margin-bottom: 3px;
                padding-bottom: 2px;
                font-size: 10.5pt;
            }

            .row.mb-4 {
                margin-bottom: .2rem !important;
            }

            h5 {
                font-size: 9pt;
                margin-top: 2px !important;
                margin-bottom: 2px !important;
            }

            p {
                margin-bottom: .08rem;
            }

            .table {
                margin-bottom: .2rem;
            }

            .table th,
            .table td {
                padding: .06rem .16rem !important;
                font-size: 7.7pt;
                line-height: 1.08;
                vertical-align: middle;
            }

            .bill-footer {
                margin-top: 3px;
                padding-top: 2px;
                font-size: 7.4pt;
                page-break-inside: avoid;
                break-inside: avoid;
            }

            .d-print-none {
                display: none !important;
            }
        }
    </style>
}

<div class="container p-3">
    <div class="text-center bill-header">
        <h2>@ViewBag.RestaurantSettings.RestaurantName</h2>
        <p class="mb-0">
            @ViewBag.RestaurantSettings.StreetAddress, @ViewBag.RestaurantSettings.City, 
            @ViewBag.RestaurantSettings.State - @ViewBag.RestaurantSettings.Pincode, @ViewBag.RestaurantSettings.Country
        </p>
        @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.PhoneNumber))
        {
            <p class="mb-0"><strong>Contact:</strong> @ViewBag.RestaurantSettings.PhoneNumber</p>
        }
        @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.Email))
        {
            <p class="mb-0"><strong>Email:</strong> @ViewBag.RestaurantSettings.Email</p>
        }
        @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.GSTCode))
        {
            <p class="mb-0"><strong>GST Code:</strong> <span class="gst-code">@ViewBag.RestaurantSettings.GSTCode</span></p>
        }
        <h4 class="mt-3 bill-title">Bill cum Receipt</h4>
    </div>

    <div class="row mb-4">
        <div class="col-6">
            <p><strong>Order #:</strong> @Model.OrderNumber</p>
            <p><strong>Date:</strong> @DateTime.Now.ToString("dd/MM/yyyy HH:mm:ss")</p>
            <p><strong>Type:</strong> @Model.OrderTypeDisplay</p>
        </div>
        <div class="col-6 text-end">
            @if (Model.OrderType == 0)
            {
                <p><strong>Table:</strong> @Model.TableName</p>
            }
            else if (Model.OrderType == 4)
            {
                <p><strong>Room:</strong> @(string.IsNullOrWhiteSpace(Model.RoomNo) ? (Model.RoomId.HasValue ? Model.RoomId.Value.ToString() : "N/A") : Model.RoomNo)</p>
            }
            else
            {
                <p><strong>Table:</strong> N/A</p>
            }
            <p><strong>Status:</strong> @Model.OrderStatusDisplay</p>
        </div>
    </div>

    <div class="row">
        <div class="col-12">
            <h5>Order Items</h5>
            <table class="table table-sm table-bordered bill-table">
                <thead>
                    <tr>
                        <th>Item</th>
                        <th class="text-center">Qty</th>
                        <th class="text-end">Price</th>
                        <th class="text-end">Total</th>
                    </tr>
                </thead>
                <tbody>
                    @foreach (var item in Model.OrderItems)
                    {
                        <tr>
                            <td>@item.MenuItemName</td>
                            <td class="text-center">@item.Quantity</td>
                            <td class="text-end">₹@item.UnitPrice.ToString("F2")</td>
                            <td class="text-end">₹@item.Subtotal.ToString("F2")</td>
                        </tr>
                    }
                </tbody>
            </table>
        </div>
    </div>

    <div class="row justify-content-end">
        <div class="col-md-5">
            @{
                var isBarOrder = ViewBag.IsBarOrder ?? false;
            }
            <table class="table table-sm">
                <tr>
                    <td>Subtotal:</td>
                    <td class="text-end">₹@Model.Subtotal.ToString("F2")</td>
                </tr>
                @{ // Standardize: round on TOTAL, not on remaining
                    var total = Model.TotalAmount; // exact total before rounding
                    var totalRounded = Math.Round(total, 0, MidpointRounding.AwayFromZero);
                    var roundOffNow = Math.Round(totalRounded - total, 2, MidpointRounding.AwayFromZero);
                    var paid = Model.PaidAmount;
                    var toProcessNow = Math.Max(0M, totalRounded - paid);
                }
                @if (toProcessNow > 0 && !isBarOrder)
                {
                    <tr>
                        <td>Payment Amount:</td>
                        <td class="text-end">₹@toProcessNow.ToString("F0")</td>
                    </tr>
                    @if (roundOffNow != 0)
                    {
                        <tr>
                            <td>Roundoff (if paid now):</td>
                            <td class="text-end">₹@roundOffNow.ToString("+0.00;-0.00;0.00")</td>
                        </tr>
                    }
                    <tr>
                        <td><strong>Total to Process:</strong></td>
                        <td class="text-end"><strong>₹@totalRounded.ToString("F0")</strong></td>
                    </tr>
                }
                
                @if (!isBarOrder)
                {
                    @if (Model.GSTPercentage > 0)
                    {
                        <tr>
                            <td>GST (@Model.GSTPercentage.ToString("F2")%):</td>
                            <td class="text-end">₹@Model.TaxAmount.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;CGST (@((Model.GSTPercentage/2).ToString("F2"))%):</td>
                            <td class="text-end">₹@Model.CGSTAmount.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;SGST (@((Model.GSTPercentage/2).ToString("F2"))%):</td>
                            <td class="text-end">₹@Model.SGSTAmount.ToString("F2")</td>
                        </tr>
                    }
                    else
                    {
                        <tr>
                            <td>GST (5.00%):</td>
                            <td class="text-end">₹@Model.TaxAmount.ToString("F2")</td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;CGST (2.50%):</td>
                            <td class="text-end">₹@((Model.TaxAmount/2).ToString("F2"))</td>
                        </tr>
                        <tr>
                            <td>&nbsp;&nbsp;SGST (2.50%):</td>
                            <td class="text-end">₹@((Model.TaxAmount/2).ToString("F2"))</td>
                        </tr>
                    }
                }
                @if (Model.DiscountAmount > 0)
                {
                    <tr>
                        <td>Discount:</td>
                        <td class="text-end text-danger">-₹@Model.DiscountAmount.ToString("F2")</td>
                    </tr>
                }
                @if (Model.TipAmount > 0)
                {
                    <tr>
                        <td>Tip:</td>
                        <td class="text-end">₹@Model.TipAmount.ToString("F2")</td>
                    </tr>
                }
                @{
                    // Prefer stored roundoff. If zero and order fully paid, compute implied roundoff
                    // from totals so printed bill shows the adjustment.
                    decimal displayRoundoff = Model.TotalRoundoff;
                    if (displayRoundoff == 0m && Model.RemainingAmount == 0m && Model.Payments != null && Model.Payments.Any())
                    {
                        // Sum of payment amounts (as recorded) vs order total -> difference is roundoff (Total - Paid)
                        var paidSum = Model.PaidAmount;
                        displayRoundoff = Math.Round(Model.TotalAmount - paidSum, 2, MidpointRounding.AwayFromZero);
                    }
                }
                @if (displayRoundoff != 0)
                {
                    <tr>
                        <td>Roundoff Adjustment:</td>
                        <td class="text-end">₹@displayRoundoff.ToString("F2")</td>
                    </tr>
                }
                <tr class="table-active">
                    <td><strong>Grand Total:</strong></td>
                    <td class="text-end"><strong>₹@totalRounded.ToString("F0")</strong></td>
                </tr>
                <tr>
                    <td>Paid:</td>
                    <td class="text-end text-success">₹@Model.PaidAmount.ToString("F2")</td>
                </tr>
                @if (Model.RemainingAmount > 0)
                {
                    <tr>
                        <td><strong>Remaining:</strong></td>
                        <td class="text-end text-danger">
                            <strong>₹@Model.RemainingAmount.ToString("F2")</strong>
                        </td>
                    </tr>
                }
            </table>
            @* Debug panel - show raw values when ?debug=1 is appended to the URL *@
            @if (ViewContext.HttpContext.Request.Query["debug"] == "1")
            {
                var preDbg = Model.RemainingAmount;
                var roundedDbg = Math.Round(preDbg, 0, MidpointRounding.AwayFromZero);
                var expectedDbg = Math.Round(roundedDbg - preDbg, 2);
                <div class="alert alert-warning mt-2 small">
                    <strong>DEBUG:</strong>
                    <div>RemainingAmount: @Model.RemainingAmount</div>
                    <div>TotalAmount: @Model.TotalAmount</div>
                    <div>PaidAmount: @Model.PaidAmount</div>
                    <div>TotalRoundoff (stored): @Model.TotalRoundoff</div>
                    <div>ComputedRounded (AwayFromZero): @roundedDbg</div>
                    <div>ComputedExpectedRoundoff: @expectedDbg</div>
                </div>
            }
        </div>
    </div>

    <!-- Payment Methods & Card Details -->
    @if (Model.Payments != null && Model.Payments.Count > 0)
    {
        <div class="row mt-4">
            <div class="col-12">
                <h5>Payments</h5>
                <table class="table table-sm table-bordered bill-table">
                    <thead>
                        <tr>
                            <th>Date</th>
                            <th>Method</th>
                            <th class="text-end">Amount</th>
                            <th class="text-end">Tip</th>
                            <th>Status</th>
                            <th>Details</th>
                        </tr>
                    </thead>
                    <tbody>
                    @foreach (var p in Model.Payments)
                    {
                        var methodDisplay = !string.IsNullOrEmpty(p.PaymentMethodDisplay) ? p.PaymentMethodDisplay : p.PaymentMethodName;
                        <tr>
                            <td>@p.CreatedAt.ToString("dd/MM/yyyy HH:mm")</td>
                            <td>@methodDisplay</td>
                            <td class="text-end">₹@p.Amount.ToString("F2")</td>
                            <td class="text-end">₹@p.TipAmount.ToString("F2")</td>
                            <td>@p.StatusDisplay</td>
                            <td style="max-width:230px; font-size: 0.8rem;">
                                @if (!string.IsNullOrEmpty(p.CardType) || !string.IsNullOrEmpty(p.LastFourDigits))
                                {
                                    <div><strong>Card:</strong> @(string.IsNullOrEmpty(p.CardType) ? "--" : p.CardType) @((!string.IsNullOrEmpty(p.LastFourDigits) ? ("•••• " + p.LastFourDigits) : ""))</div>
                                }
                                @if (!string.IsNullOrEmpty(p.AuthorizationCode))
                                {
                                    <div><strong>Auth:</strong> @p.AuthorizationCode</div>
                                }
                                @if (!string.IsNullOrEmpty(p.ReferenceNumber))
                                {
                                    <div><strong>Ref:</strong> @p.ReferenceNumber</div>
                                }
                                @if (p.DiscAmount.HasValue && p.DiscAmount.Value > 0)
                                {
                                    <div class="text-danger"><strong>Discount:</strong> -₹@p.DiscAmount.Value.ToString("F2")</div>
                                }
                                @if (p.GSTAmount.HasValue && p.GSTAmount.Value > 0)
                                {
                                    <div><strong>GST:</strong> ₹@p.GSTAmount.Value.ToString("F2") (@(p.GST_Perc?.ToString("F2") ?? "-")%)</div>
                                }
                                @if (p.RoundoffAdjustmentAmt.HasValue && p.RoundoffAdjustmentAmt.Value != 0)
                                {
                                    <div><strong>Roundoff:</strong> ₹@p.RoundoffAdjustmentAmt.Value.ToString("F2")</div>
                                }
                            </td>
                        </tr>
                    }
                    </tbody>
                </table>
            </div>
        </div>
    }

    @* UPI QR Code Section - Show only if enabled and there's remaining balance.
       Use rounded-total settlement so QR doesn't show when roundoff completes the order. *@
    @{ 
        var qrTotal = Model.TotalAmount;
        var qrTotalRounded = Math.Round(qrTotal, 0, MidpointRounding.AwayFromZero);
        var qrPaid = Model.PaidAmount;
        var qrOutstanding = Math.Max(0M, qrTotalRounded - qrPaid);
    }
    @if (Model.UPIEnabled && qrOutstanding > 0.001M && !string.IsNullOrEmpty(Model.UPIQRCodeDataUrl))
    {
        <div class="row mt-4">
            <div class="col-12">
                <div class="card border-primary">
                    <div class="card-header bg-primary text-white text-center">
                        <h5 class="mb-0"><i class="fas fa-qrcode"></i> Scan to Pay Remaining Balance</h5>
                    </div>
                    <div class="card-body text-center">
                        <div class="mb-3">
                            <img src="@Model.UPIQRCodeDataUrl" alt="UPI QR Code" style="max-width: 200px; height: auto;" />
                        </div>
                        <div class="mb-2">
                            <h4 class="text-primary mb-0">₹@qrOutstanding.ToString("F2")</h4>
                            <p class="small text-muted mb-0">Amount to Pay</p>
                        </div>
                        <div class="mb-2">
                            <p class="small mb-1">
                                <i class="fas fa-mobile-alt text-success"></i>
                                Scan with any UPI app to pay instantly
                            </p>
                            <p class="small text-muted mb-0">
                                Google Pay • PhonePe • Paytm • BHIM
                            </p>
                        </div>
                        @if (!string.IsNullOrEmpty(Model.UPIPayeeName))
                        {
                            <div class="mt-2">
                                <p class="small mb-0"><strong>Payee:</strong> @Model.UPIPayeeName</p>
                            </div>
                        }
                    </div>
                </div>
            </div>
        </div>
    }

    <div class="row mt-4">
        <div class="col-12 text-center bill-footer">
            <p>Thank you for dining with us!</p>
            <p class="small">For questions about your bill, please contact @ViewBag.RestaurantSettings.RestaurantName.</p>
            @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.PhoneNumber))
            {
                <p class="small mb-0">Contact: @ViewBag.RestaurantSettings.PhoneNumber</p>
            }
            @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.Email))
            {
                <p class="small">Email: @ViewBag.RestaurantSettings.Email</p>
            }
            @if (!string.IsNullOrEmpty(ViewBag.RestaurantSettings.Website))
            {
                <p class="small">Website: @ViewBag.RestaurantSettings.Website</p>
            }
        </div>
    </div>

    <div class="d-print-none mt-4 text-center">
        <button type="button" class="btn btn-primary" onclick="window.print();">
            <i class="fas fa-print"></i> Print Bill
        </button>
        <a asp-action="Index" asp-route-id="@Model.OrderId" class="btn btn-secondary">
            Back to Payment
        </a>
    </div>
</div>

@section Scripts {
    <script>
        $(document).ready(function() {
            // Auto-print when page loads
            setTimeout(function() {
                window.print();
            }, 500);
        });
    </script>
}